<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Chat iOS Dark Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        /* --- CONFIGURAÇÕES DARK MODE & THEME --- */
        :root {
            --bg-app: #000000;
            --bg-secondary: #1C1C1E;
            --bg-header: #161616;
            --text-primary: #FFFFFF;
            --text-secondary: #8E8E93;
            --separator: #2C2C2E;
            --accent-color: #0A84FF;
            --bubble-me: #3E1010;
            --bubble-them: #2C2C2E;
            --chat-bg-color: #0b141a;
        }

        body, html { 
            height: 100%; width: 100%; overflow: hidden; 
            background: var(--bg-app); 
            color: var(--text-primary);
            font-family: -apple-system, BlinkMacSystemFont, sans-serif; 
            -webkit-tap-highlight-color: transparent; 
        }
        
        /* LAYOUT & Z-INDEX */
        #login-screen { z-index: 9999; background-color: var(--bg-app); }
        #main-app { z-index: 10; position: absolute; inset: 0; display: flex; flex-direction: column; background-color: var(--bg-app); }
        
        /* TELA DE CHAT (SLIDE OVER) */
        #chat-room { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background-color: var(--chat-bg-color);
            background-image: linear-gradient(rgba(0,0,0,0.85), rgba(0,0,0,0.85)), url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png');
            background-blend-mode: overlay;
            z-index: 100;
            transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.25, 1, 0.5, 1);
            display: flex; flex-direction: column;
        }
        .chat-open { transform: translateX(0) !important; }
        
        /* BALÕES DE MENSAGEM */
        .msg-bubble { 
            max-width: 75%; padding: 6px 10px; font-size: 16px; 
            border-radius: 8px; margin-bottom: 4px; position: relative; 
            color: #FFF; 
        }
        .msg-me { 
            background: var(--bubble-me); align-self: flex-end; 
            border-radius: 18px 18px 4px 18px; margin-right: 10px; 
        }
        .msg-them { 
            background: var(--bubble-them); align-self: flex-start; 
            border-radius: 18px 18px 18px 4px; margin-left: 10px; 
        }
        
        /* STATUS VIEWER */
        #story-viewer {
            position: fixed; inset: 0; z-index: 200; background: black;
            display: flex; flex-direction: column;
            transform: scale(0.9); opacity: 0; pointer-events: none;
            transition: all 0.2s ease-out;
        }
        #story-viewer.active { transform: scale(1); opacity: 1; pointer-events: all; }
        
        .story-progress-container {
            display: flex; gap: 4px; padding: 10px 4px; 
            position: absolute; top: 0; left: 0; right: 0; z-index: 50;
        }
        .story-progress-bar {
            height: 2px; flex: 1; background: rgba(255,255,255,0.3); border-radius: 2px; overflow: hidden;
        }
        .story-progress-fill {
            height: 100%; background: white; width: 0%;
        }
        
        .story-media {
            width: 100%; height: 100%; object-fit: contain; display: block;
        }

        /* STATUS CREATOR (FIXED KEYBOARD ISSUE) */
        #status-creator {
            position: fixed; inset: 0; z-index: 150; background: #000;
            display: flex; flex-direction: column; height: 100%;
            transform: translateY(100%); transition: transform 0.3s;
        }
        #status-creator.open { transform: translateY(0); }
        
        /* Ajuste para garantir que a área de input não suma */
        .creator-footer {
            flex-shrink: 0; background: #1C1C1E; width: 100%; padding-bottom: env(safe-area-inset-bottom);
        }

        /* STATUS RING */
        .status-ring { padding: 2px; border-radius: 50%; border: 2px solid #0A84FF; }
        .status-ring-viewed { border-color: #545458; }

        /* UTILITÁRIOS */
        .safe-pb { padding-bottom: env(safe-area-inset-bottom); }
        .active-tab svg { color: #FF3B30; }
        .active-tab span { color: #FF3B30; }
        .input-dark { background-color: #2C2C2E; color: white; border: none; }
        .input-dark::placeholder { color: #8E8E93; }
        
        .tick-icon { font-size: 11px; margin-left: 3px; font-weight: bold; letter-spacing: -1px; }
        .tick-read { color: #34B7F1; }
        .tick-sent { color: #8E8E93; }
    </style>
</head>
<body>

    <div id="login-screen" class="fixed inset-0 flex flex-col items-center justify-center p-8">
        <h1 class="text-3xl font-bold mb-8 text-[#FF3B30]">WhatsApp Pro</h1>
        <input id="u_auth" placeholder="Usuário" class="w-full input-dark p-4 rounded-xl mb-3 outline-none focus:ring-1 focus:ring-red-500">
        <input id="p_auth" type="password" placeholder="Senha" class="w-full input-dark p-4 rounded-xl mb-6 outline-none focus:ring-1 focus:ring-red-500">
        <button onclick="auth('login')" class="w-full bg-[#FF3B30] active:bg-red-700 text-white py-4 rounded-xl font-bold transition">Entrar</button>
        <button onclick="auth('register')" class="mt-4 text-[#FF3B30] font-medium">Criar Conta</button>
    </div>

    <div id="main-app" class="hidden">
        
        <header class="bg-[#161616] border-b border-[#2C2C2E] pt-safe pb-3 px-4 flex justify-between items-center shrink-0 min-h-[60px]">
            <button class="text-[#FF3B30] text-[17px]">Editar</button>
            <h1 id="header-title" class="font-bold text-[18px] text-white">Conversas</h1>
            <button onclick="document.getElementById('new-chat-modal').classList.remove('hidden')" class="text-[#FF3B30]">
                <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
            </button>
        </header>

        <div class="flex-1 overflow-y-auto relative">
            
            <div id="tab-chats" class="w-full">
                <div class="px-4 py-2 bg-[#161616]">
                    <input placeholder="Pesquisar" class="w-full bg-[#2C2C2E] text-white rounded-lg px-3 py-1.5 text-center outline-none placeholder-gray-500 focus:text-left focus:pl-3 transition-all">
                </div>
                <div id="chat-list" class="pl-4 border-t border-[#2C2C2E]"></div>
            </div>

            <div id="tab-status" class="hidden w-full min-h-full pb-20">
                <h1 class="text-3xl font-bold px-4 py-4 text-white">Status</h1>
                
                <div class="bg-[#1C1C1E] px-4 py-3 flex items-center gap-3 border-y border-[#2C2C2E] relative">
                     <div class="relative">
                        <img id="my_status_pic" class="w-14 h-14 rounded-full bg-gray-700 object-cover">
                        <button onclick="openStatusCreator()" class="absolute bottom-0 right-0 bg-[#0A84FF] rounded-full p-1 border-2 border-[#1C1C1E] text-white">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" stroke-width="3" viewBox="0 0 24 24"><path d="M12 4v16m8-8H4"/></svg>
                        </button>
                     </div>
                     <div class="flex-1 cursor-pointer" onclick="checkMyStatus()">
                         <h3 class="font-bold text-white">Meu Status</h3>
                         <p class="text-gray-400 text-sm">Toque para ver, + para adicionar</p>
                     </div>
                     <div class="flex gap-4 text-[#0A84FF]">
                        <button onclick="openStatusCreator('text')" class="bg-[#2C2C2E] p-2 rounded-full"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/></svg></button>
                        <button onclick="openStatusCreator('media')" class="bg-[#2C2C2E] p-2 rounded-full"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/></svg></button>
                     </div>
                </div>
                
                <h4 class="text-gray-500 text-xs font-bold px-4 mt-6 mb-2 uppercase">Atualizações Recentes</h4>
                <div id="status-list" class="bg-[#1C1C1E] pl-4 border-t border-b border-[#2C2C2E]"></div>
            </div>

            <div id="tab-settings" class="hidden w-full min-h-full pb-20">
                <h1 class="text-3xl font-bold px-4 py-4 text-white">Ajustes</h1>
                <div class="bg-[#1C1C1E] border-y border-[#2C2C2E] flex items-center p-4 gap-4 mb-8" onclick="document.getElementById('avatar_file').click()">
                    <img id="settings_avatar" class="w-16 h-16 rounded-full bg-gray-700 object-cover">
                    <div class="flex-1">
                        <h2 id="settings_name" class="text-xl font-semibold text-white">User</h2>
                        <p class="text-gray-400 text-sm">Toque para mudar foto</p>
                    </div>
                    <input type="file" id="avatar_file" hidden accept="image/*" onchange="updateProfilePic(event)">
                </div>
                <div class="bg-[#1C1C1E] border-y border-[#2C2C2E] p-4 mb-8">
                    <label class="text-xs text-gray-500 uppercase">Recado</label>
                    <input id="settings_bio" class="w-full mt-1 text-[17px] bg-transparent text-white outline-none" onblur="saveBio(this.value)">
                </div>
                <button onclick="logout()" class="w-full bg-[#1C1C1E] p-4 text-[#FF3B30] text-lg border-y border-[#2C2C2E] text-left">Sair</button>
            </div>
        </div>

        <nav class="bg-[#161616]/95 backdrop-blur border-t border-[#2C2C2E] h-[83px] flex justify-around pt-2 pb-safe shrink-0 z-50">
            <button onclick="switchTab('status')" id="btn-status" class="flex flex-col items-center gap-1 w-16 text-[#8E8E93]">
                <svg class="w-7 h-7" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3"/></svg>
                <span class="text-[10px] font-medium">Status</span>
            </button>
            <button onclick="switchTab('chats')" id="btn-chats" class="active-tab flex flex-col items-center gap-1 w-16 text-[#8E8E93]">
                <svg class="w-7 h-7" viewBox="0 0 24 24" fill="currentColor"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/></svg>
                <span class="text-[10px] font-medium">Conversas</span>
            </button>
            <button onclick="switchTab('settings')" id="btn-settings" class="flex flex-col items-center gap-1 w-16 text-[#8E8E93]">
                <svg class="w-7 h-7" viewBox="0 0 24 24" fill="currentColor"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                <span class="text-[10px] font-medium">Ajustes</span>
            </button>
        </nav>
    </div>

    <div id="chat-room">
        <header class="h-16 bg-[#161616]/95 backdrop-blur border-b border-[#2C2C2E] flex items-center px-2 shrink-0 z-50 shadow-sm pt-safe">
            <button onclick="closeChat()" class="flex items-center text-[#FF3B30] pr-2 h-full">
                <svg class="w-8 h-8" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M15 19l-7-7 7-7"/></svg>
                <span class="text-[17px] -ml-1">Voltar</span>
            </button>
            <div class="flex-1 flex items-center gap-3 cursor-pointer py-1" onclick="document.getElementById('contact-modal').classList.remove('hidden')">
                <img id="chat_avatar" class="w-9 h-9 rounded-full bg-gray-700 object-cover border border-[#2C2C2E]">
                <div class="flex flex-col justify-center">
                    <h3 id="chat_name" class="font-semibold text-[16px] leading-tight text-white">--</h3>
                    <span id="chat_status" class="text-[11px] text-gray-400 leading-tight">Toque para dados</span>
                </div>
            </div>
        </header>

        <div id="msg-container" class="flex-1 overflow-y-auto p-4 flex flex-col pb-4"></div>

        <div class="bg-[#161616] border-t border-[#2C2C2E] px-2 py-2 flex items-end gap-2 pb-safe shrink-0">
            <button onclick="document.getElementById('media_input').click()" class="text-[#FF3B30] p-2 mb-1">
                <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 4v16m8-8H4"/></svg>
            </button>
            <input type="file" id="media_input" hidden accept="image/*,video/*" onchange="sendMedia(event)">
            <div class="flex-1 bg-[#2C2C2E] border border-[#3A3A3C] rounded-2xl min-h-[36px] flex items-center px-3 py-1 mb-1">
                <input id="chat-input" class="w-full bg-transparent outline-none text-[16px] text-white max-h-24" placeholder="" onkeydown="handleKey(event)">
            </div>
            <button onclick="sendText()" id="send-btn" class="text-[#FF3B30] font-bold p-2 mb-1 hidden">Enviar</button>
            <button onclick="toggleMic()" id="mic-btn" class="text-[#FF3B30] p-2 mb-1"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"/></svg></button>
        </div>
    </div>

    <div id="story-viewer">
        <div class="story-progress-container" id="story-bars"></div>
        
        <div class="flex items-center gap-3 p-4 z-20 mt-4 absolute top-0 left-0 right-0 pt-safe">
            <button onclick="closeStory()" class="text-white"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg></button>
            <img id="sv-avatar" class="w-10 h-10 rounded-full border border-white/20 bg-gray-700">
            <div>
                <h3 id="sv-username" class="font-bold text-white text-sm shadow-black drop-shadow-md">User</h3>
                <span id="sv-time" class="text-xs text-white/80">Há 20 min</span>
            </div>
        </div>

        <div id="sv-content" class="absolute inset-0 flex items-center justify-center bg-black"></div>
        
        <div id="sv-caption-container" class="absolute bottom-16 left-0 right-0 p-4 text-center z-20 pointer-events-none">
             <p id="sv-caption" class="text-white bg-black/50 p-2 rounded-lg inline-block text-lg pointer-events-auto"></p>
        </div>

        <div class="absolute inset-0 flex z-10">
            <div class="w-1/3 h-full" onclick="prevStory()"></div>
            <div class="w-2/3 h-full" onclick="nextStory()"></div>
        </div>

        <div id="sv-footer" class="absolute bottom-0 w-full p-4 pb-safe bg-black/40 backdrop-blur z-30 hidden flex justify-center">
            <button onclick="showViewers()" class="flex flex-col items-center text-white pointer-events-auto">
                <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>
                <span class="text-xs" id="sv-view-count">0 views</span>
            </button>
        </div>
    </div>

    <div id="viewers-modal" class="fixed inset-0 z-[250] hidden bg-black/80 backdrop-blur-sm" onclick="this.classList.add('hidden')">
        <div class="absolute inset-x-0 bottom-0 bg-[#1C1C1E] rounded-t-2xl max-h-[60%] overflow-y-auto p-4 pb-safe" onclick="event.stopPropagation()">
            <h3 class="text-white font-bold text-lg mb-4 text-center">Visualizado por</h3>
            <div id="viewers-list" class="space-y-3"></div>
        </div>
    </div>

    <div id="status-creator">
        <div class="flex justify-between items-center p-4 pt-safe shrink-0">
            <button onclick="closeStatusCreator()" class="text-white text-lg">Cancelar</button>
            <button onclick="submitStatus()" class="text-[#0A84FF] font-bold text-lg">Enviar</button>
        </div>
        
        <div class="flex-1 relative flex flex-col justify-center items-center overflow-hidden min-h-0" id="st-preview-area">
            <textarea id="st-text-input" class="hidden w-full h-full bg-transparent text-white text-4xl text-center p-8 outline-none resize-none flex items-center justify-center font-bold" placeholder="Digite seu status..."></textarea>
            <img id="st-img-preview" class="hidden max-h-full max-w-full object-contain">
            <video id="st-video-preview" class="hidden max-h-full max-w-full object-contain" controls></video>
        </div>

        <div class="creator-footer p-4 bg-[#1C1C1E] w-full shrink-0">
            <input id="st-caption" class="w-full bg-[#2C2C2E] text-white p-3 rounded-xl mb-4" placeholder="Adicione uma legenda...">
            
            <div id="st-controls-text" class="hidden flex justify-center gap-4 mb-4">
                <div onclick="setBg('#ff0055')" class="w-8 h-8 rounded-full bg-[#ff0055] border-2 border-white cursor-pointer"></div>
                <div onclick="setBg('#0099ff')" class="w-8 h-8 rounded-full bg-[#0099ff] border-2 border-white cursor-pointer"></div>
                <div onclick="setBg('#6600cc')" class="w-8 h-8 rounded-full bg-[#6600cc] border-2 border-white cursor-pointer"></div>
                <div onclick="setBg('#00cc66')" class="w-8 h-8 rounded-full bg-[#00cc66] border-2 border-white cursor-pointer"></div>
                <div onclick="setBg('#ff9900')" class="w-8 h-8 rounded-full bg-[#ff9900] border-2 border-white cursor-pointer"></div>
            </div>
            
            <input type="file" id="st-file-input" hidden accept="image/*,video/*" onchange="handleStatusFile(event)">
        </div>
    </div>

    <div id="new-chat-modal" class="fixed inset-0 z-[200] hidden bg-black/70 backdrop-blur-sm">
        <div class="absolute inset-x-0 bottom-0 bg-[#1C1C1E] rounded-t-2xl p-4 pb-10 border-t border-[#3A3A3C]">
            <div class="flex justify-between mb-4">
                <button onclick="document.getElementById('new-chat-modal').classList.add('hidden')" class="text-[#FF3B30] font-bold">Cancelar</button>
                <span class="font-bold text-white">Nova Conversa</span>
                <span class="w-10"></span>
            </div>
            <input id="new-chat-input" placeholder="Usuário exato..." class="w-full p-3 rounded-lg border border-[#3A3A3C] bg-[#2C2C2E] text-white outline-none">
            <button onclick="startChat()" class="w-full bg-[#FF3B30] active:bg-red-700 text-white font-bold py-3 mt-4 rounded-lg transition">Iniciar</button>
        </div>
    </div>

    <div id="contact-modal" class="fixed inset-0 z-[200] hidden bg-black/70 backdrop-blur-sm" onclick="this.classList.add('hidden')">
        <div class="absolute inset-x-0 bottom-0 bg-[#1C1C1E] rounded-t-2xl h-[70%] p-6 flex flex-col items-center border-t border-[#3A3A3C]" onclick="event.stopPropagation()">
            <img id="info_avatar" class="w-32 h-32 rounded-full bg-gray-700 object-cover mb-4 shadow-lg border-2 border-[#2C2C2E]">
            <h2 id="info_name" class="text-2xl font-bold mb-1 text-white">Nome</h2>
            <p id="info_bio" class="text-gray-400 text-center bg-[#2C2C2E] p-4 rounded-xl w-full shadow-sm">Sem recado.</p>
        </div>
    </div>

    <script>
        const socket = io();
        let me = null, active = null;

        // --- ÍCONE DE VERIFICADO ---
        function getVerifiedIcon(isVerified) {
            if (!isVerified) return '';
            return `
            <svg class="w-4 h-4 ml-1 inline-block text-[#1D9BF0]" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12.0001 2C12.4401 2 12.8701 2.13 13.2401 2.38L14.7301 3.33C15.0201 3.52 15.3501 3.63 15.7001 3.63C15.7901 3.63 15.8901 3.62 15.9801 3.61L17.7401 3.44C18.6801 3.35 19.5701 3.96 19.8201 4.88L20.2901 6.59C20.3801 6.93 20.5801 7.23 20.8501 7.44L22.2801 8.52C23.0301 9.09 23.2701 10.1 22.8401 10.94L22.0401 12.53C21.8901 12.83 21.8901 13.18 22.0401 13.48L22.8401 15.07C23.2701 15.91 23.0301 16.92 22.2801 17.49L20.8501 18.57C20.5801 18.78 20.3801 19.08 20.2901 19.42L19.8201 21.13C19.5701 22.05 18.6801 22.66 17.7401 22.57L15.9801 22.4C15.8901 22.39 15.7901 22.38 15.7001 22.38C15.3501 22.38 15.0101 22.49 14.7301 22.68L13.2401 23.63C12.4901 24.11 11.5101 24.11 10.7601 23.63L9.27006 22.68C8.98006 22.49 8.65006 22.38 8.30006 22.38C8.21006 22.38 8.11006 22.39 8.02006 22.4L6.26006 22.57C5.32006 22.66 4.43006 22.05 4.18006 21.13L3.71006 19.42C3.62006 19.08 3.42006 18.78 3.15006 18.57L1.72006 17.49C0.97006 16.92 0.73006 15.91 1.16006 15.07L1.96006 13.48C2.11006 13.18 2.11006 12.83 1.96006 12.53L1.16006 10.94C0.73006 10.1 0.97006 9.09 1.72006 8.52L3.15006 7.44C3.42006 7.23 3.62006 6.93 3.71006 6.59L4.18006 4.88C4.43006 3.96 5.32006 3.35 6.26006 3.44L8.02006 3.61C8.11006 3.62 8.21006 3.63 8.30006 3.63C8.65006 3.63 8.98006 3.52 9.27006 3.33L10.7601 2.38C11.1301 2.13 11.5601 2 12.0001 2ZM10.5901 16.17L17.6601 9.1L16.2401 7.68L10.5901 13.34L7.76006 10.51L6.34006 11.92L10.5901 16.17Z" />
            </svg>`;
        }

        // --- SISTEMA DE LOGIN ---
        window.onload = () => {
            const s = localStorage.getItem('whats_v4');
            if(s) { me = JSON.parse(s); enter(); }
        };

        async function auth(endpoint) {
            const u = document.getElementById('u_auth').value.trim();
            const p = document.getElementById('p_auth').value.trim();
            if(!u || !p) return alert("Preencha usuário e senha");
            
            try {
                const res = await fetch('/' + endpoint, {
                    method:'POST',
                    headers:{'Content-Type':'application/json'},
                    body:JSON.stringify({username:u, password:p})
                });
                
                const data = await res.json();
                
                if(res.ok) {
                    if(endpoint === 'login'){
                        me = data; 
                        localStorage.setItem('whats_v4', JSON.stringify(me)); 
                        enter();
                    } else {
                        alert("Usuário criado! Agora faça login.");
                        // Não tenta logar direto, força o user a clicar em entrar
                    }
                } else {
                    alert(data.error || "Erro na autenticação");
                }
            } catch(e) {
                alert("Erro de conexão com o servidor");
            }
        }

        function enter() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            socket.emit('join', me.username);
            updateMeUI(); 
            loadChats();
        }

        function logout() { localStorage.removeItem('whats_v4'); location.reload(); }

        // --- FUNÇÕES DE UI E CHAT ---
        async function loadChats() {
            const d = await fetch('/chats/'+me.username).then(r=>r.json());
            document.getElementById('chat-list').innerHTML = d.map(c => `
                <div onclick="openChat('${c.contact}')" class="flex items-center gap-3 py-3 pr-4 border-b border-[#2C2C2E] cursor-pointer bg-[#161616] active:bg-[#2C2C2E]">
                    <div class="relative">
                        <img src="${c.avatar || 'https://ui-avatars.com/api/?name='+c.contact}" class="w-14 h-14 rounded-full bg-gray-700 object-cover">
                        ${c.is_online ? '<div class="absolute bottom-0 right-0 w-3.5 h-3.5 bg-green-500 rounded-full border-2 border-[#161616]"></div>' : ''}
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex justify-between">
                            <h3 class="font-bold text-[17px] text-white truncate flex items-center">
                                ${c.contact} ${getVerifiedIcon(c.is_verified)}
                            </h3>
                            <span class="text-sm text-gray-500">${c.last_time ? new Date(c.last_time).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}) : ''}</span>
                        </div>
                        <p class="text-gray-400 truncate text-sm">${c.last_msg || ''}</p>
                    </div>
                </div>
            `).join('');
        }

        async function openChat(u) {
            active = u;
            const userData = await fetch('/user/'+u).then(r=>r.json());
            
            // Header do Chat com Verificado
            document.getElementById('chat_name').innerHTML = `${u} ${getVerifiedIcon(userData.is_verified)}`;
            document.getElementById('chat_avatar').src = userData.avatar || `https://ui-avatars.com/api/?name=${u}`;
            
            // Info do Perfil Lateral
            document.getElementById('info_name').innerHTML = `${u} ${getVerifiedIcon(userData.is_verified)}`;
            document.getElementById('info_avatar').src = userData.avatar || `https://ui-avatars.com/api/?name=${u}`;
            document.getElementById('info_bio').innerText = userData.bio || "Sem recado";

            document.getElementById('chat-room').classList.add('chat-open');
            const msgs = await fetch(`/messages/${me.username}/${active}`).then(r=>r.json());
            const div = document.getElementById('msg-container');
            div.innerHTML = '';
            msgs.forEach(addMsg);
            div.scrollTop = div.scrollHeight;
        }

        function addMsg(m) {
            const isMe = m.s === me.username;
            let content = m.type === 'image' 
                ? `<img src="${m.c}" class="rounded-lg max-w-full border border-gray-600">` 
                : `<span class="break-words">${m.c}</span>`;
                
            const div = document.createElement('div');
            div.className = `flex flex-col mb-2 ${isMe ? 'items-end' : 'items-start'}`;
            div.innerHTML = `
                <div class="${isMe ? 'bg-[#005c4b]' : 'bg-[#202c33]'} p-2 rounded-lg max-w-[75%] text-white text-sm relative">
                    ${content}
                    <div class="text-[10px] text-gray-300 text-right mt-1">${new Date(m.time).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</div>
                </div>`;
            document.getElementById('msg-container').appendChild(div);
        }

        function closeChat() {
            document.getElementById('chat-room').classList.remove('chat-open');
            active = null;
            loadChats();
        }

        // --- ENVIAR MENSAGEM ---
        function handleKey(e) { if(e.key === 'Enter') sendText(); }
        
        function sendText() {
            const i = document.getElementById('chat-input');
            const txt = i.value.trim();
            if(!txt) return;
            const d = { s:me.username, r:active, c:txt, type:'text' };
            socket.emit('send_msg', d);
            addMsg({...d, time: new Date()});
            i.value = '';
            document.getElementById('msg-container').scrollTop = document.getElementById('msg-container').scrollHeight;
        }

        // --- UPDATE PROFILE ---
        function updateMeUI() {
            const pic = me.avatar || `https://ui-avatars.com/api/?name=${me.username}`;
            document.getElementById('settings_avatar').src = pic;
            document.getElementById('settings_name').innerHTML = `${me.username} ${getVerifiedIcon(me.is_verified)}`;
            document.getElementById('settings_bio').value = me.bio;
        }

        async function updateProfilePic(e) {
            const f = e.target.files[0];
            if(!f) return;
            const r = new FileReader();
            r.onload = async () => {
                me.avatar = r.result; // Envia base64, server salva e devolve caminho
                const res = await fetch('/update-profile', {
                    method:'POST', headers:{'Content-Type':'application/json'}, 
                    body:JSON.stringify(me)
                });
                const d = await res.json();
                if(d.ok) { 
                    me.avatar = d.avatar; 
                    localStorage.setItem('whats_v4', JSON.stringify(me));
                    updateMeUI(); 
                }
            };
            r.readAsDataURL(f);
        }

        // --- ABAS ---
        function switchTab(t) {
            ['chats','settings'].forEach(x => {
                document.getElementById('tab-'+x).classList.add('hidden');
                document.getElementById('btn-'+x).classList.remove('active-tab');
            });
            document.getElementById('tab-'+t).classList.remove('hidden');
            document.getElementById('btn-'+t).classList.add('active-tab');
            if(t==='chats') loadChats();
        }

        // --- SOCKET LISTENERS ---
        socket.on('new_msg', m => { if(active===m.s) { addMsg(m); } else { loadChats(); } });
    </script>

        socket.on('msg_sent_ok', m => {
            if(active === m.r) {
                const bubbles = document.querySelectorAll('.msg-me');
                const lastBubble = bubbles[bubbles.length - 1];
                if(lastBubble) lastBubble.querySelector('.tick-icon').innerHTML = '✓✓';
            }
        });

        socket.on('msgs_read_update', d => { 
            if(active===d.reader) {
                document.querySelectorAll('.tick-sent').forEach(e => {
                    e.classList.remove('tick-sent');
                    e.classList.add('tick-read');
                });
            }
        });

        socket.on('user_status_change', data => {
            if(active === data.username) {
                const stDiv = document.getElementById('chat_status');
                if(data.status === 'online') {
                    stDiv.innerText = 'Online';
                    stDiv.className = 'text-[12px] text-[#0A84FF] font-medium leading-tight';
                } else {
                    const time = data.last_seen ? formatTimeUTC(data.last_seen) : new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
                    stDiv.innerText = 'Visto por último hoje às ' + time;
                    stDiv.className = 'text-[11px] text-gray-400 leading-tight';
                }
            }
            loadChats();
        });

        socket.on('status_viewed', data => {
            if(active === null && !document.getElementById('viewers-modal').classList.contains('hidden')) {
                showViewers(); 
            }
        });
    </script>
</body>
</html>
