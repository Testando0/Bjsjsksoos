<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RED PROTOCOL V7</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap');
        body { background: #000; color: #eee; font-family: sans-serif; }
        .red-glow { border: 1px solid rgba(255, 0, 0, 0.3); box-shadow: 0 0 15px rgba(255, 0, 0, 0.1); }
        .tick { font-size: 10px; margin-left: 4px; }
        .tick-read { color: #38bdf8; } /* Azul para lido */
        .unread-badge { background: #ff0000; color: white; border-radius: 50%; padding: 2px 6px; font-size: 10px; font-weight: bold; }
        .msg-me { background: #7f1d1d; border-radius: 12px 12px 2px 12px; align-self: flex-end; }
        .msg-them { background: #18181b; border-radius: 12px 12px 12px 2px; align-self: flex-start; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <div id="auth-box" class="fixed inset-0 z-[200] bg-black flex items-center justify-center p-6">
        <div class="bg-zinc-900 p-8 w-full max-w-sm rounded-2xl red-glow">
            <h1 style="font-family:'Orbitron'" class="text-red-600 text-3xl font-black mb-8 text-center uppercase tracking-tighter">Red<span class="text-white">OS</span></h1>
            <input id="u" placeholder="USUÁRIO" class="w-full bg-black p-4 mb-3 border border-zinc-800 outline-none rounded-xl focus:border-red-600">
            <input id="p" type="password" placeholder="SENHA" class="w-full bg-black p-4 mb-8 border border-zinc-800 outline-none rounded-xl focus:border-red-600">
            <button onclick="auth('login')" class="w-full bg-red-600 py-4 rounded-xl font-bold uppercase">Acessar</button>
        </div>
    </div>

    <div id="app" class="hidden h-full flex flex-col">
        <header class="h-16 flex items-center justify-between px-6 bg-zinc-900 border-b border-red-900/30">
            <span style="font-family:'Orbitron'" class="text-red-600 font-bold text-xs">RED PROTOCOL</span>
            <button onclick="logout()" class="text-[10px] text-zinc-500 uppercase">Sair</button>
        </header>

        <main id="chat-list" class="flex-1 overflow-y-auto divide-y divide-zinc-900"></main>

        <button onclick="newChat()" class="fixed bottom-8 right-8 w-14 h-14 bg-red-600 rounded-full shadow-lg text-2xl font-bold">+</button>
    </div>

    <div id="chat-win" class="fixed inset-0 bg-black z-[150] hidden flex flex-col">
        <header class="h-16 bg-zinc-900 flex items-center px-4 gap-4 border-b border-red-600">
            <button onclick="closeChat()" class="text-red-600 text-2xl">←</button>
            <div class="flex-1">
                <h4 id="t-name" class="font-bold text-sm uppercase">User</h4>
                <p id="t-status" class="text-[8px] text-zinc-500 uppercase">Offline</p>
            </div>
        </header>
        <div id="msgs-box" class="flex-1 overflow-y-auto p-4 flex flex-col gap-4"></div>
        <div class="p-4 bg-zinc-900 flex gap-2">
            <input id="m-input" class="flex-1 bg-black p-4 rounded-xl border border-zinc-800 outline-none" placeholder="Mensagem...">
            <button onclick="sendMsg()" class="bg-red-600 px-6 rounded-xl font-bold">➔</button>
        </div>
    </div>

    <script>
        const socket = io();
        let me = null, target = null;

        // --- AUTH ---
        window.onload = () => {
            const s = localStorage.getItem('red_v7');
            if(s) { me = JSON.parse(s); startApp(); }
        };

        async function auth(type) {
            const u = document.getElementById('u').value, p = document.getElementById('p').value;
            const res = await fetch(`/${type}`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({username:u, password:p}) });
            if(res.ok) {
                me = await res.json();
                localStorage.setItem('red_v7', JSON.stringify(me));
                location.reload();
            }
        }

        function startApp() {
            document.getElementById('auth-box').remove();
            document.getElementById('app').classList.remove('hidden');
            socket.emit('join', me.username);
            loadChats();
        }

        // --- CHATS LIST ---
        async function loadChats() {
            const res = await fetch(`/chats/${me.username}`).then(r => r.json());
            const container = document.getElementById('chat-list');
            container.innerHTML = res.map(c => {
                const isMe = c.last_sender === me.username;
                const tickHtml = isMe ? getTickHtml(c.last_status) : '';
                return `
                <div onclick="openChat('${c.contact}')" class="p-4 flex items-center gap-4 active:bg-zinc-900">
                    <div class="w-12 h-12 rounded-full bg-red-900 border border-red-600 flex items-center justify-center font-bold">${c.contact[0]}</div>
                    <div class="flex-1 overflow-hidden">
                        <div class="flex justify-between"><h4 class="text-sm font-bold uppercase">${c.contact}</h4><span class="text-[10px] text-zinc-600">12:00</span></div>
                        <div class="flex justify-between items-center">
                            <p class="text-xs text-zinc-500 truncate">${tickHtml} ${c.last_msg || ''}</p>
                            ${c.unread > 0 ? `<span class="unread-badge">${c.unread}</span>` : ''}
                        </div>
                    </div>
                </div>`;
            }).join('');
        }

        function getTickHtml(status) {
            if (status === 0) return `<span class="tick text-zinc-600">✓</span>`;
            if (status === 1) return `<span class="tick text-zinc-400">✓✓</span>`;
            if (status === 2) return `<span class="tick tick-read">✓✓</span>`;
            return '';
        }

        // --- CHAT WINDOW ---
        async function openChat(name) {
            target = name;
            document.getElementById('chat-win').classList.remove('hidden');
            document.getElementById('t-name').innerText = name;
            socket.emit('mark_read', { s: target, r: me.username });
            const msgs = await fetch(`/messages/${me.username}/${target}`).then(r => r.json());
            document.getElementById('msgs-box').innerHTML = '';
            msgs.forEach(m => appendMsg(m));
            loadChats(); // Limpa bolinha de não lidas
        }

        function sendMsg() {
            const val = document.getElementById('m-input').value;
            if(!val) return;
            const tempId = Date.now();
            const msg = { s: me.username, r: target, c: val, type: 'text', status: 0, tempId };
            socket.emit('send_msg', msg);
            appendMsg(msg);
            document.getElementById('m-input').value = '';
        }

        socket.on('new_msg', (d) => {
            if(target === d.s) {
                appendMsg(d);
                socket.emit('mark_read', { s: target, r: me.username });
            }
            loadChats();
        });

        socket.on('msgs_read_by_target', (d) => {
            if(target === d.by) {
                document.querySelectorAll('.tick').forEach(t => {
                    t.innerText = '✓✓';
                    t.classList.add('tick-read');
                });
            }
            loadChats();
        });

        function appendMsg(d) {
            const isMe = d.s === me.username;
            const div = document.createElement('div');
            div.className = isMe ? 'msg-me p-3 text-sm max-w-[80%] flex flex-col' : 'msg-them p-3 text-sm max-w-[80%]';
            div.innerHTML = `<span>${d.c}</span><div class="text-[8px] self-end opacity-50">${isMe ? getTickHtml(d.status) : ''}</div>`;
            const box = document.getElementById('msgs-box');
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
        }

        function closeChat() { document.getElementById('chat-win').classList.add('hidden'); target = null; loadChats(); }
        function newChat() { const n = prompt("USER:"); if(n) openChat(n); }
        function logout() { localStorage.clear(); location.reload(); }
    </script>
</body>
</html>
