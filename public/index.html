<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="manifest" href="/manifest.json">
    <title>Messenger Titanium</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        /* TEMA TITANIUM / CINZA */
        :root {
            --bg-primary: #000000;
            --bg-secondary: #1C1C1E;
            --bg-tertiary: #2C2C2E;
            --accent-gray: #8E8E93; /* Cinza iOS */
            --accent-white: #F2F2F7; /* Branco Ativo */
            --separator: #38383A;
            
            /* Bolhas de Chat */
            --msg-me: #3A3A3C; /* Cinza Escuro para mim */
            --msg-them: #1C1C1E; /* Cinza mais escuro para eles */
            --text-me: #FFFFFF;
            
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        body { background: var(--bg-primary); color: white; overflow: hidden; margin: 0; height: 100vh; touch-action: manipulation; }
        
        .hidden { display: none !important; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        /* Anima√ß√µes */
        .slide-up { animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        /* Estilo das Bolhas */
        .msg-bubble { 
            padding: 10px 14px; 
            border-radius: 20px; 
            max-width: 75%; 
            position: relative; 
            word-wrap: break-word; 
            font-size: 15px; 
            line-height: 1.4; 
            margin-bottom: 4px; 
        }
        .msg-me { background: var(--msg-me); color: var(--text-me); align-self: flex-end; border-bottom-right-radius: 4px; }
        .msg-them { background: var(--msg-them); align-self: flex-start; border-bottom-left-radius: 4px; border: 1px solid #333; }
        .msg-group-sender { font-size: 11px; color: var(--accent-gray); margin-bottom: 2px; font-weight: 700; }
        
        input:focus, textarea:focus { outline: none; }
        .tab-active { color: var(--accent-white); background: var(--bg-tertiary); }
        .tab-inactive { color: #636366; }
        
        .pulse-ring { animation: pulse-gray 2s infinite; }
        @keyframes pulse-gray { 0% { box-shadow: 0 0 0 0 rgba(142, 142, 147, 0.7); } 70% { box-shadow: 0 0 0 20px rgba(142, 142, 147, 0); } 100% { box-shadow: 0 0 0 0 rgba(142, 142, 147, 0); } }
    </style>
</head>
<body class="flex flex-col">

    <div id="auth-screen" class="fixed inset-0 z-[5000] bg-black flex flex-col items-center justify-center p-8">
        <div class="w-full max-w-sm text-center">
            <div class="w-16 h-16 bg-[#2C2C2E] rounded-2xl mx-auto mb-6 flex items-center justify-center">
                <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg>
            </div>
            <h1 class="text-2xl font-bold mb-2 text-white tracking-tight">Titanium Chat</h1>
            <p class="text-gray-500 mb-8 text-sm">Profissional. Seguro. R√°pido.</p>
            <input id="u_auth" placeholder="Usu√°rio" class="w-full bg-[#1C1C1E] px-4 py-4 rounded-xl border border-[#2C2C2E] text-white mb-3 text-lg focus:border-gray-500 transition">
            <input id="p_auth" type="password" placeholder="Senha" class="w-full bg-[#1C1C1E] px-4 py-4 rounded-xl border border-[#2C2C2E] text-white mb-8 text-lg focus:border-gray-500 transition">
            <button onclick="access('login')" class="w-full bg-white text-black py-4 rounded-xl font-bold text-lg active:scale-95 transition">Entrar</button>
            <button onclick="access('register')" class="w-full py-4 text-gray-500 font-medium mt-2 text-sm">Criar conta</button>
        </div>
    </div>

    <div id="call-incoming-overlay" class="fixed inset-0 z-[4000] bg-black/95 hidden flex-col items-center justify-between py-12 slide-up backdrop-blur-md">
        <div class="flex flex-col items-center mt-10">
            <img id="inc_call_avatar" class="w-24 h-24 rounded-full bg-gray-800 mb-4 object-cover border-2 border-[#333]">
            <h2 id="inc_call_name" class="text-2xl font-bold">Usu√°rio</h2>
            <p class="text-gray-400">Chamada de voz...</p>
        </div>
        <div class="flex w-full justify-around px-10">
            <button onclick="rejectCall()" class="flex flex-col items-center gap-2">
                <div class="w-16 h-16 rounded-full bg-[#FF453A] flex items-center justify-center text-white"><svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></div>
            </button>
            <button onclick="acceptCall()" class="flex flex-col items-center gap-2">
                <div class="w-16 h-16 rounded-full bg-[#32D74B] flex items-center justify-center text-white pulse-ring"><svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path></svg></div>
            </button>
        </div>
    </div>

    <div id="call-active-overlay" class="fixed inset-0 z-[4000] bg-[#1C1C1E] hidden flex-col items-center py-12">
        <div class="flex-1 flex flex-col items-center justify-center">
            <img id="act_call_avatar" class="w-32 h-32 rounded-full border-4 border-[#2C2C2E] mb-6 object-cover">
            <h2 id="act_call_name" class="text-3xl font-bold mb-2">Em chamada</h2>
            <p id="call_timer" class="text-gray-400 font-mono text-xl">Conectando...</p>
            <audio id="remote_audio" autoplay></audio>
        </div>
        <div class="pb-10">
            <button onclick="endCall()" class="w-16 h-16 rounded-full bg-[#FF453A] flex items-center justify-center hover:opacity-80 transition">
                <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 8l2-2m0 0l2-2m-2 2l-2 2m-2 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            </button>
        </div>
    </div>

    <div id="app" class="hidden flex-1 flex flex-col w-full h-full max-w-md mx-auto relative bg-black border-x border-[#333]">
        
        <header class="h-[60px] px-4 flex justify-between items-center bg-[#1C1C1E]/90 backdrop-blur border-b border-[#2C2C2E] sticky top-0 z-50">
            <button onclick="openNewGroup()" class="text-white text-sm font-medium opacity-80 hover:opacity-100">Novo Grupo</button>
            <h1 class="font-bold text-lg tracking-wide">Chats</h1>
            <button onclick="openNewChat()" class="w-8 h-8 rounded-full bg-[#2C2C2E] flex items-center justify-center text-white hover:bg-white hover:text-black transition">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
            </button>
        </header>

        <div class="w-full flex p-1 bg-[#1C1C1E] border-b border-[#2C2C2E]">
            <button onclick="tab('chats')" id="t-chats" class="flex-1 py-2 text-xs font-bold uppercase tracking-wider rounded-lg transition-all tab-active">Conversas</button>
            <button onclick="tab('feed')" id="t-feed" class="flex-1 py-2 text-xs font-bold uppercase tracking-wider rounded-lg transition-all tab-inactive">Feed</button>
            <button onclick="tab('profile')" id="t-profile" class="flex-1 py-2 text-xs font-bold uppercase tracking-wider rounded-lg transition-all tab-inactive">Perfil</button>
        </div>

        <main class="flex-1 overflow-y-auto relative scroll-smooth no-scrollbar">
            <div id="view-chats" class="pb-24"></div>

            <div id="view-feed" class="hidden pb-24">
                <div class="p-4 border-b border-[#2C2C2E] flex gap-3 items-center cursor-pointer hover:bg-[#1C1C1E] transition" onclick="openPostModal()">
                    <img id="feed_me_av" class="w-10 h-10 rounded-full bg-gray-800 object-cover border border-[#333]">
                    <div class="flex-1 h-10 bg-[#1C1C1E] rounded-full flex items-center px-4 text-gray-500 text-sm border border-[#2C2C2E]">O que est√° acontecendo?</div>
                </div>
                <div id="feed_list" class="flex flex-col gap-2 bg-black pt-2"></div>
            </div>

            <div id="view-profile" class="hidden p-6 flex flex-col items-center">
                <div class="relative mb-6 cursor-pointer group" onclick="document.getElementById('p_file').click()">
                    <img id="my_pic_large" class="w-28 h-28 rounded-full border-4 border-[#1C1C1E] object-cover bg-gray-800">
                    <div class="absolute inset-0 flex items-center justify-center bg-black/50 rounded-full opacity-0 group-hover:opacity-100 transition">
                        <span class="text-xs font-bold">ALTERAR</span>
                    </div>
                </div>
                <input type="file" id="p_file" class="hidden" accept="image/*" onchange="updateAvatar(event)">
                <h2 id="my_name_display" class="text-2xl font-bold mb-1 text-white"></h2>
                <input id="my_bio_input" class="bg-transparent text-center text-gray-400 mb-6 w-full border-b border-[#2C2C2E] focus:border-white pb-2 transition" placeholder="Sua bio...">
                <button onclick="saveProfile()" class="w-full bg-[#2C2C2E] py-4 rounded-xl text-white font-bold mb-3 hover:bg-[#3A3A3C] transition">Salvar Perfil</button>
                <button onclick="logout()" class="w-full py-4 text-[#FF453A] font-bold text-sm">Sair da Conta</button>
            </div>
        </main>
    </div>

    <div id="chat-win" class="fixed inset-0 z-[1000] bg-black hidden flex flex-col slide-up">
        <header class="h-[90px] pt-8 pb-2 px-3 bg-[#1C1C1E]/95 backdrop-blur flex items-center gap-3 border-b border-[#2C2C2E] shrink-0">
            <button onclick="closeChat()" class="text-white px-2 flex items-center gap-1 hover:opacity-70 transition">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
            </button>
            <div class="flex-1 flex items-center gap-3 cursor-pointer" onclick="openChatSettings()">
                <img id="chat_h_img" class="w-10 h-10 rounded-full bg-gray-700 object-cover border border-[#333]">
                <div>
                    <h4 id="chat_h_name" class="font-bold text-base text-white leading-tight">Nome</h4>
                    <span id="chat_h_status" class="text-[11px] text-gray-400 font-medium">Toque para info</span>
                </div>
            </div>
            <button onclick="startVoiceCall()" class="w-10 h-10 rounded-full bg-[#2C2C2E] text-white flex items-center justify-center hover:bg-white hover:text-black transition">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path></svg>
            </button>
        </header>

        <div id="msg_flow" class="flex-1 overflow-y-auto p-4 flex flex-col gap-1 bg-black"></div>

        <div class="bg-[#1C1C1E] p-3 pb-8 border-t border-[#2C2C2E] flex items-end gap-3">
            <div class="flex-1 bg-[#2C2C2E] rounded-2xl flex items-center px-4 min-h-[44px] border border-transparent focus-within:border-gray-600 transition">
                <textarea id="m_in" rows="1" class="w-full bg-transparent text-white text-base resize-none py-2 max-h-32 placeholder-gray-500" placeholder="Mensagem..." onkeydown="if(event.key==='Enter' && !event.shiftKey){event.preventDefault();sendMsg();}"></textarea>
            </div>
            <button id="send_btn" onclick="sendMsg()" class="w-11 h-11 bg-white rounded-full flex items-center justify-center text-black shrink-0 hover:bg-gray-200 transition shadow-lg">
                <svg class="w-5 h-5 ml-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M5 10l7-7m0 0l7 7m-7-7v18"/></svg>
            </button>
        </div>
    </div>

    <div id="modal-container" class="fixed inset-0 z-[2000] hidden bg-black/90 backdrop-blur-sm flex items-end sm:items-center justify-center"></div>

    <script>
        const socket = io({ reconnection: true });
        let me = null, active = null;
        let activeIsGroup = false;
        
        let localStream, remoteStream, peerConnection;
        const rtcConfig = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };
        let callIncomingData = null, callTimerInt = null;

        // INICIALIZA√á√ÉO
        window.onload = () => {
            const saved = localStorage.getItem('red_v4'); // Mantive a key storage
            if(saved) {
                try {
                    me = JSON.parse(saved);
                    document.getElementById('auth-screen').classList.add('hidden');
                    document.getElementById('app').classList.remove('hidden');
                    socket.emit('join', me.username);
                    updateProfileUI();
                    tab('chats');
                } catch(e) { localStorage.clear(); }
            }
        };

        async function access(type) {
            const u = document.getElementById('u_auth').value.trim();
            const p = document.getElementById('p_auth').value.trim();
            if(!u || !p) return alert("Preencha todos os campos");
            const res = await fetch('/'+type, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({username: u, password: p})
            });
            if(res.ok) {
                if(type === 'login') {
                    me = await res.json();
                    localStorage.setItem('red_v4', JSON.stringify(me));
                    location.reload();
                } else alert("Conta criada com sucesso! Fa√ßa login.");
            } else alert("Erro ao acessar. Verifique seus dados.");
        }

        function tab(t) {
            ['chats', 'feed', 'profile'].forEach(x => {
                document.getElementById('view-'+x).classList.add('hidden');
                document.getElementById('t-'+x).className = 'flex-1 py-2 text-xs font-bold uppercase tracking-wider rounded-lg transition-all tab-inactive';
            });
            document.getElementById('view-'+t).classList.remove('hidden');
            document.getElementById('t-'+t).className = 'flex-1 py-2 text-xs font-bold uppercase tracking-wider rounded-lg transition-all tab-active';
            if(t==='chats') loadChats();
            if(t==='feed') loadFeed();
        }

        function updateProfileUI() {
            const pic = me.avatar || `https://ui-avatars.com/api/?name=${me.username}&background=333&color=fff`;
            document.getElementById('my_pic_large').src = pic;
            document.getElementById('feed_me_av').src = pic;
            document.getElementById('my_name_display').innerText = me.username;
            document.getElementById('my_bio_input').value = me.bio || '';
        }

        async function updateAvatar(e) {
            const file = e.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = () => document.getElementById('my_pic_large').src = reader.result;
            reader.readAsDataURL(file);
        }

        async function saveProfile() {
            const avatar = document.getElementById('my_pic_large').src;
            const bio = document.getElementById('my_bio_input').value;
            await fetch('/update-profile', {
                method: 'POST',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify({username: me.username, bio, avatar})
            });
            me.avatar = avatar; me.bio = bio;
            localStorage.setItem('red_v4', JSON.stringify(me));
            alert("Perfil salvo!");
        }

        function logout() { localStorage.removeItem('red_v4'); location.reload(); }

        // --- CHAT LOGIC ---
        async function loadChats() {
            const data = await fetch(`/chats/${me.username}`).then(r => r.json());
            const list = document.getElementById('view-chats');
            if(data.length === 0) return list.innerHTML = `<div class="text-center mt-20 text-gray-600 text-sm">Nenhuma conversa.<br>Inicie um novo chat.</div>`;
            
            list.innerHTML = data.map(c => {
                const isGroup = c.is_group === 1;
                const pic = c.avatar || (isGroup ? 'https://cdn-icons-png.flaticon.com/512/694/694642.png' : `https://ui-avatars.com/api/?name=${c.contact}&background=333&color=fff`);
                const name = c.display_name || c.contact;
                
                return `
                <div onclick="openChat('${c.contact}', ${isGroup}, '${pic}', '${name}')" class="flex items-center gap-3 p-4 active:bg-[#1C1C1E] cursor-pointer transition border-b border-[#1C1C1E]">
                    <img src="${pic}" class="w-14 h-14 rounded-full bg-[#2C2C2E] object-cover shrink-0 border border-[#333]">
                    <div class="flex-1 min-w-0">
                        <div class="flex justify-between items-baseline mb-1">
                            <h4 class="text-white font-bold truncate text-[15px]">${name}</h4>
                            <span class="text-gray-500 text-xs font-mono">${c.last_time || ''}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <p class="text-gray-400 text-sm truncate pr-2 w-full font-medium">${c.last_sender === me.username ? '<span class="text-white">Voc√™:</span> ' : ''}${c.last_msg || 'Nova conversa'}</p>
                            ${c.unread > 0 ? `<div class="w-5 h-5 bg-white text-black rounded-full flex items-center justify-center text-[10px] font-bold shadow-md scale-90">${c.unread}</div>` : ''}
                        </div>
                    </div>
                </div>`;
            }).join('');
        }

        async function openChat(id, isGroup, avatar, name) {
            active = id;
            activeIsGroup = isGroup;
            document.getElementById('chat-win').classList.remove('hidden');
            document.getElementById('chat_h_name').innerText = name;
            document.getElementById('chat_h_status').innerText = isGroup ? 'Grupo ‚Ä¢ Toque para info' : 'Online';
            document.getElementById('chat_h_img').src = avatar;
            loadMsgs();
            socket.emit('mark_read', { s: active, r: me.username, isGroup });
        }

        function closeChat() {
            document.getElementById('chat-win').classList.add('hidden');
            active = null;
            loadChats();
        }

        async function loadMsgs() {
            if(!active) return;
            const msgs = await fetch(`/messages/${me.username}/${active}`).then(r => r.json());
            const flow = document.getElementById('msg_flow');
            
            flow.innerHTML = msgs.map(m => {
                const isMe = m.s === me.username;
                const showSender = activeIsGroup && !isMe;
                return `
                <div class="${isMe ? 'msg-me' : 'msg-them'} msg-bubble flex flex-col shadow-sm">
                    ${showSender ? `<span class="msg-group-sender">${m.s}</span>` : ''}
                    <span>${m.c}</span>
                    <span class="text-[9px] opacity-60 self-end mt-1 font-mono tracking-tighter">${m.f_time}</span>
                </div>`;
            }).join('');
            flow.scrollTop = flow.scrollHeight;
        }

        function sendMsg() {
            const input = document.getElementById('m_in');
            const txt = input.value.trim();
            if(!txt || !active) return;
            
            console.log("Enviando para:", active, "Grupo:", activeIsGroup); // Debug

            socket.emit('send_msg', {
                s: me.username,
                r: active,
                c: txt,
                type: 'text',
                isGroup: activeIsGroup
            });
            input.value = '';
        }

        socket.on('new_msg', m => {
            // L√≥gica ajustada para ID de grupo ou Username
            if(active && ( (activeIsGroup && m.group_id == active) || (!activeIsGroup && (m.s == active || m.r == active)) )) {
                loadMsgs();
            } else {
                // Tocar som discreto?
            }
            loadChats();
        });
        
        socket.on('msg_sent_ok', () => {
             if(active) loadMsgs(); 
             loadChats();
        });

        // --- CHAMADAS E GRUPOS (L√≥gica mantida mas com design Titanium) ---
        async function startVoiceCall() {
            if(activeIsGroup) return alert("Chamadas de grupo em breve.");
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                setupPeerConnection();
                localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));
                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);
                socket.emit('call_user', { userToCall: active, signalData: offer, from: me.username });
                showActiveCallUI(active, document.getElementById('chat_h_img').src, "Chamando...");
            } catch(e) { alert("Erro ao acessar microfone."); }
        }

        // ... (Mesma l√≥gica de WebRTC do c√≥digo anterior, apenas UI alterada via CSS) ...
        socket.on('call_incoming', (data) => {
            callIncomingData = data;
            document.getElementById('inc_call_name').innerText = data.from;
            document.getElementById('inc_call_avatar').src = `https://ui-avatars.com/api/?name=${data.from}&background=333&color=fff`;
            document.getElementById('call-incoming-overlay').classList.remove('hidden');
            document.getElementById('call-incoming-overlay').classList.add('flex');
        });
        async function acceptCall() {
            document.getElementById('call-incoming-overlay').classList.add('hidden');
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                setupPeerConnection();
                localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));
                await peerConnection.setRemoteDescription(new RTCSessionDescription(callIncomingData.signal));
                const answer = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(answer);
                socket.emit('answer_call', { signal: answer, to: callIncomingData.from });
                showActiveCallUI(callIncomingData.from, `https://ui-avatars.com/api/?name=${callIncomingData.from}`, "Conectado");
            } catch(e) { alert("Erro ao aceitar"); }
        }
        function rejectCall() { document.getElementById('call-incoming-overlay').classList.add('hidden'); }
        socket.on('call_accepted', async (signal) => {
            await peerConnection.setRemoteDescription(new RTCSessionDescription(signal));
            document.getElementById('call_timer').innerText = "Conectado";
            startCallTimer();
        });
        socket.on('ice_candidate', async (candidate) => { if(peerConnection) await peerConnection.addIceCandidate(new RTCIceCandidate(candidate)); });
        socket.on('call_ended', endCallLocal);
        function setupPeerConnection() {
            peerConnection = new RTCPeerConnection(rtcConfig);
            peerConnection.onicecandidate = (e) => { if(e.candidate && (active || callIncomingData)) socket.emit('ice_candidate', { to: active || callIncomingData.from, candidate: e.candidate }); };
            peerConnection.ontrack = (e) => document.getElementById('remote_audio').srcObject = e.streams[0];
        }
        function showActiveCallUI(name, avatar, status) {
            const ui = document.getElementById('call-active-overlay');
            ui.classList.remove('hidden'); ui.classList.add('flex');
            document.getElementById('act_call_name').innerText = name; document.getElementById('act_call_avatar').src = avatar; document.getElementById('call_timer').innerText = status;
        }
        function endCall() { const target = active || (callIncomingData ? callIncomingData.from : null); if(target) socket.emit('end_call', { to: target }); endCallLocal(); }
        function endCallLocal() { if(peerConnection) peerConnection.close(); if(localStream) localStream.getTracks().forEach(t => t.stop()); document.getElementById('call-active-overlay').classList.add('hidden'); document.getElementById('call-active-overlay').classList.remove('flex'); clearInterval(callTimerInt); active = null; }
        function startCallTimer() { let s = 0; callTimerInt = setInterval(() => { s++; const m = Math.floor(s/60); const sec = s%60; document.getElementById('call_timer').innerText = `${m}:${sec<10?'0'+sec:sec}`; }, 1000); }

        // --- FEED & GROUPS UI (Design Titanium) ---
        async function loadFeed() {
            const posts = await fetch('/get-feed').then(r => r.json());
            document.getElementById('feed_list').innerHTML = posts.map(p => `
                <div class="bg-[#1C1C1E] mb-4 pb-3 border-b border-[#2C2C2E]">
                    <div class="flex items-center gap-3 p-3">
                        <img src="${p.user_avatar || 'https://ui-avatars.com/api/?name='+p.username}" class="w-8 h-8 rounded-full border border-[#333]">
                        <span class="font-bold text-sm text-white">${p.username}</span>
                    </div>
                    ${p.type === 'image' ? `<img src="${p.content}" class="w-full h-auto max-h-[500px] object-cover">` : `<div class="p-4 text-lg font-serif text-gray-200">${p.content}</div>`}
                    <div class="p-3 pt-2">
                        ${p.caption ? `<p class="text-sm text-gray-300"><span class="font-bold text-white mr-2">${p.username}</span>${p.caption}</p>` : ''}
                    </div>
                </div>`).join('');
        }

        function openPostModal() {
            const modal = document.getElementById('modal-container');
            modal.innerHTML = `
                <div class="bg-[#1C1C1E] w-full max-w-lg rounded-t-2xl sm:rounded-2xl p-6 slide-up border-t border-[#333]">
                    <h2 class="text-xl font-bold mb-4 text-white">Novo Post</h2>
                    <textarea id="post_text" class="w-full bg-[#2C2C2E] p-4 rounded-xl text-white mb-4 h-32 focus:bg-[#333] transition" placeholder="No que est√° pensando?"></textarea>
                    <label class="block w-full bg-[#2C2C2E] p-4 rounded-xl text-center text-white mb-4 cursor-pointer hover:bg-[#333] transition border border-dashed border-[#444]">
                        üì∑ Adicionar Foto
                        <input type="file" id="post_img" class="hidden" accept="image/*">
                    </label>
                    <button onclick="submitPost()" class="w-full bg-white text-black py-3 rounded-xl font-bold hover:bg-gray-200 transition">Postar</button>
                    <button onclick="document.getElementById('modal-container').classList.add('hidden')" class="w-full py-3 text-[#FF453A] mt-2 text-sm font-bold">Cancelar</button>
                </div>
            `;
            modal.classList.remove('hidden');
        }

        async function submitPost() {
            const txt = document.getElementById('post_text').value; const file = document.getElementById('post_img').files[0];
            if(!txt && !file) return;
            // ... (L√≥gica de postagem mantida, apenas chamando loadFeed no final)
            if(file) {
                const reader = new FileReader();
                reader.onload = async () => {
                    await fetch('/post-feed', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ username: me.username, content: reader.result, caption: txt, type: 'image' }) });
                    document.getElementById('modal-container').classList.add('hidden'); loadFeed();
                }; reader.readAsDataURL(file);
            } else {
                await fetch('/post-feed', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ username: me.username, content: txt, caption: '', type: 'text' }) });
                document.getElementById('modal-container').classList.add('hidden'); loadFeed();
            }
        }

        // ... (L√≥gica de Modais de Grupo e Novo Chat com design Cinza) ...
        async function openNewGroup() {
             const users = await fetch('/users-all').then(r => r.json());
             const filtered = users.filter(u => u.username !== me.username);
             const modal = document.getElementById('modal-container');
             modal.innerHTML = `
                <div class="bg-[#1C1C1E] w-full max-w-lg rounded-t-2xl sm:rounded-2xl p-6 slide-up h-[80vh] flex flex-col border-t border-[#333]">
                    <h2 class="text-xl font-bold mb-4 text-white">Criar Grupo</h2>
                    <input id="new_group_name" placeholder="Nome do Grupo" class="w-full bg-[#2C2C2E] p-4 rounded-xl text-white mb-4 focus:border-white border border-transparent transition">
                    <p class="text-sm text-gray-500 mb-2 font-bold uppercase">Membros</p>
                    <div class="flex-1 overflow-y-auto mb-4 bg-black p-2 rounded-xl border border-[#2C2C2E]">
                        ${filtered.map(u => `<div class="flex items-center gap-3 p-3 border-b border-[#222]"><input type="checkbox" value="${u.username}" class="chk-member w-5 h-5 accent-white rounded"><img src="${u.avatar||'https://ui-avatars.com/api/?name='+u.username}" class="w-8 h-8 rounded-full"><span>${u.username}</span></div>`).join('')}
                    </div>
                    <button onclick="createGroup()" class="w-full bg-white text-black py-3 rounded-xl font-bold hover:bg-gray-200">Criar Grupo</button>
                    <button onclick="document.getElementById('modal-container').classList.add('hidden')" class="w-full py-3 text-[#FF453A] mt-2 font-bold">Cancelar</button>
                </div>`;
             modal.classList.remove('hidden');
        }
        
        function createGroup() {
            const name = document.getElementById('new_group_name').value.trim();
            const checks = document.querySelectorAll('.chk-member:checked');
            const members = Array.from(checks).map(c => c.value);
            if(name) { socket.emit('create_group', { name, members, owner: me.username }); document.getElementById('modal-container').classList.add('hidden'); }
        }
        socket.on('group_created', () => loadChats());

        function openChatSettings() {
            if(!activeIsGroup) return;
            fetch('/group/'+active).then(r=>r.json()).then(g => {
                const modal = document.getElementById('modal-container');
                modal.innerHTML = `
                    <div class="bg-[#1C1C1E] w-full max-w-lg rounded-t-2xl sm:rounded-2xl p-6 slide-up max-h-[80vh] overflow-y-auto">
                        <div class="flex flex-col items-center mb-4">
                            <img src="${g.avatar||'https://cdn-icons-png.flaticon.com/512/694/694642.png'}" class="w-24 h-24 rounded-full mb-2 bg-[#2C2C2E] border-4 border-black">
                            <h2 class="text-2xl font-bold text-white">${g.name}</h2>
                        </div>
                        <h3 class="font-bold mb-2 text-gray-400 text-xs uppercase">Participantes</h3>
                        <div class="flex flex-col gap-2 mb-6">
                            ${g.members.map(m => `<div class="flex items-center justify-between p-3 bg-[#2C2C2E] rounded-xl"><span class="${m.is_admin?'text-white font-bold':'text-gray-300'}">${m.username}</span>${m.is_admin?'<span class="text-[10px] bg-white text-black px-2 py-1 rounded font-bold">ADMIN</span>':''}</div>`).join('')}
                        </div>
                        <button onclick="document.getElementById('modal-container').classList.add('hidden')" class="w-full py-3 bg-[#2C2C2E] text-white rounded-xl font-bold">Fechar</button>
                    </div>`;
                modal.classList.remove('hidden');
            });
        }

        function openNewChat() {
             const modal = document.getElementById('modal-container');
             modal.innerHTML = `
                <div class="bg-[#1C1C1E] w-full max-w-sm rounded-2xl p-6 slide-up border border-[#333]">
                    <h2 class="text-xl font-bold mb-4 text-white">Nova Mensagem</h2>
                    <input id="nc_input" class="w-full bg-[#2C2C2E] p-4 rounded-xl text-white mb-4 focus:border-white border border-transparent" placeholder="Nome do usu√°rio">
                    <button onclick="startNewChatAction()" class="w-full bg-white text-black py-3 rounded-xl font-bold hover:bg-gray-200">Iniciar</button>
                    <button onclick="document.getElementById('modal-container').classList.add('hidden')" class="w-full py-3 text-[#FF453A] mt-2 font-bold">Cancelar</button>
                </div>`;
             modal.classList.remove('hidden');
        }
        async function startNewChatAction() {
            const u = document.getElementById('nc_input').value.trim();
            const r = await fetch('/user/'+u).then(d=>d.json());
            if(r.username) { document.getElementById('modal-container').classList.add('hidden'); openChat(u, false, r.avatar || `https://ui-avatars.com/api/?name=${u}`, u); } else alert("Usu√°rio n√£o encontrado");
        }
    </script>
</body>
</html>
