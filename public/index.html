<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#F2F2F7">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <link rel="manifest" href="/manifest.json">
    <title>WhatsApp</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/socket.io/socket.io.js"></script>
    
    <style>
        /* Configura√ß√µes Globais e Vari√°veis iOS */
        :root {
            --ios-bg: #FFFFFF;
            --ios-bg-sec: #F2F2F7;
            --ios-blue: #007AFF;
            --ios-green: #34C759;
            --ios-gray: #8E8E93;
            --ios-separator: #C6C6C8;
            --bubble-me: #E1FFC7; /* Verde claro cl√°ssico */
            --bubble-them: #FFFFFF;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--ios-bg-sec);
            color: #000;
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        /* Utilit√°rios */
        .hidden { display: none !important; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .safe-pb { padding-bottom: env(safe-area-inset-bottom); }
        .safe-pt { padding-top: env(safe-area-inset-top); }

        /* Anima√ß√µes de Transi√ß√£o de Tela */
        .page {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            transition: transform 0.3s cubic-bezier(0.25, 1, 0.5, 1);
            background: var(--ios-bg-sec);
            z-index: 10;
        }
        .page-enter { transform: translateX(100%); }
        .page-active { transform: translateX(0); }
        .page-exit { transform: translateX(-30%); opacity: 0.8; }

        /* Bal√µes de Mensagem */
        .msg-bubble {
            max-width: 75%;
            padding: 6px 10px 8px 10px;
            font-size: 16px;
            line-height: 1.3;
            position: relative;
            box-shadow: 0 1px 1px rgba(0,0,0,0.1);
        }
        .msg-me {
            background-color: var(--bubble-me);
            align-self: flex-end;
            border-radius: 18px 18px 4px 18px;
            margin-right: 10px;
        }
        .msg-them {
            background-color: var(--bubble-them);
            align-self: flex-start;
            border-radius: 18px 18px 18px 4px;
            margin-left: 10px;
        }
        .msg-info {
            font-size: 11px;
            color: rgba(0,0,0,0.45);
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 4px;
            margin-top: 2px;
            float: right;
            margin-left: 8px;
        }

        /* Chat Wallpaper */
        .chat-bg {
            background-color: #E5DDD5;
            background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png');
            background-blend-mode: overlay;
        }

        /* Tab Bar */
        .tab-icon { fill: #8E8E93; }
        .active-tab .tab-icon { fill: #007AFF; }
        .active-tab span { color: #007AFF; }

        /* Input Bar */
        .input-bar {
            background: #F6F6F6;
            border-top: 1px solid #C6C6C8;
        }
        
        /* Modal */
        .modal-overlay { background: rgba(0,0,0,0.4); }
        .modal-content { animation: slideUp 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    </style>
</head>
<body class="h-screen w-screen flex flex-col">

    <div id="login-screen" class="fixed inset-0 z-[5000] bg-white flex flex-col items-center justify-center p-8">
        <div class="mb-10 flex flex-col items-center">
            <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/6/6b/WhatsApp.svg/1200px-WhatsApp.svg.png" class="w-20 h-20 mb-4">
            <h1 class="text-2xl font-semibold text-black">WhatsApp Web</h1>
        </div>
        
        <div class="w-full max-w-sm space-y-4">
            <input id="u_auth" type="text" placeholder="Nome de usu√°rio" class="w-full bg-gray-100 p-4 rounded-xl text-lg outline-none border border-transparent focus:border-green-500 transition">
            <input id="p_auth" type="password" placeholder="Senha" class="w-full bg-gray-100 p-4 rounded-xl text-lg outline-none border border-transparent focus:border-green-500 transition">
            
            <button onclick="auth('login')" class="w-full bg-[#007AFF] text-white py-4 rounded-xl font-bold text-lg active:opacity-80 transition">Entrar</button>
            <button onclick="auth('register')" class="w-full text-[#007AFF] py-2 font-medium">Criar Conta</button>
        </div>
        <p class="absolute bottom-8 text-gray-400 text-xs text-center">from<br><b class="text-gray-600 text-sm tracking-widest">FACEBOOK</b></p>
    </div>

    <div id="main-app" class="hidden h-full flex flex-col bg-white relative">
        
        <header id="main-header" class="h-16 bg-[#F2F2F7]/90 backdrop-blur-md border-b border-[#C6C6C8] flex justify-between items-end px-4 pb-3 sticky top-0 z-20">
            <button onclick="toggleEdit()" class="text-[#007AFF] text-[17px]">Editar</button>
            <h1 class="font-semibold text-[17px]">Conversas</h1>
            <button onclick="openNewChatModal()" class="text-[#007AFF]"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg></button>
        </header>

        <div id="tab-chats" class="flex-1 overflow-y-auto bg-white">
            <div class="px-4 py-2 bg-[#F2F2F7]">
                <div class="bg-[#E3E3E8] rounded-lg flex items-center px-2 py-1.5 gap-2">
                    <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                    <input type="text" placeholder="Pesquisar" class="bg-transparent w-full outline-none text-[17px] placeholder-gray-500">
                </div>
            </div>
            
            <div class="border-t border-[#C6C6C8] pl-4 space-y-0" id="chat-list">
                </div>
            
            <div class="h-20"></div> </div>

        <div id="tab-status" class="hidden flex-1 overflow-y-auto bg-[#F2F2F7]">
            <header class="h-24 bg-[#F2F2F7] px-4 pb-2 flex items-end font-bold text-3xl">Status</header>
            <div class="px-4 py-2">
                <div class="bg-white rounded-xl p-3 flex items-center gap-3" onclick="document.getElementById('status_file').click()">
                    <div class="relative">
                        <img id="my_status_avatar" class="w-14 h-14 rounded-full bg-gray-200 object-cover">
                        <div class="absolute bottom-0 right-0 bg-[#007AFF] rounded-full w-5 h-5 flex items-center justify-center text-white border-2 border-white text-xs font-bold">+</div>
                    </div>
                    <div>
                        <h3 class="font-semibold text-lg">Meu Status</h3>
                        <p class="text-gray-500 text-[15px]">Adicionar ao meu status</p>
                    </div>
                </div>
                <input type="file" id="status_file" hidden accept="image/*" onchange="postStatus(event)">
            </div>
            <div class="px-4 mt-6 text-gray-500 text-sm uppercase mb-2">Atualiza√ß√µes Recentes</div>
            <div id="status-list" class="bg-white border-y border-[#C6C6C8] pl-4"></div>
        </div>

        <div id="tab-settings" class="hidden flex-1 bg-[#F2F2F7]">
            <header class="h-24 bg-[#F2F2F7] px-4 pb-2 flex items-end font-bold text-3xl">Ajustes</header>
            <div class="mt-4 bg-white border-y border-[#C6C6C8]">
                <div class="flex items-center gap-4 p-4 cursor-pointer" onclick="document.getElementById('avatar_file').click()">
                    <img id="settings_avatar" class="w-16 h-16 rounded-full object-cover bg-gray-200">
                    <div class="flex-1">
                        <h2 id="settings_name" class="text-xl font-semibold">User</h2>
                        <p id="settings_bio" class="text-gray-500">Bio...</p>
                    </div>
                    <svg class="w-5 h-5 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                </div>
                <input type="file" id="avatar_file" hidden accept="image/*" onchange="updateAvatar(event)">
            </div>

            <div class="mt-8 bg-white border-y border-[#C6C6C8]">
                <button onclick="logout()" class="w-full text-left p-4 text-red-500 text-lg">Sair</button>
            </div>
        </div>

        <nav class="bg-[#F2F2F7]/90 backdrop-blur-md border-t border-[#C6C6C8] h-[83px] fixed bottom-0 w-full flex justify-around pt-2 pb-safe z-30">
            <button onclick="switchTab('status')" id="btn-status" class="flex flex-col items-center gap-1 w-16">
                <svg class="w-7 h-7 tab-icon" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13h2v6h-2zm0 8h2v2h-2z"/></svg>
                <span class="text-[10px] font-medium text-[#8E8E93]">Status</span>
            </button>
            <button onclick="switchTab('chats')" id="btn-chats" class="active-tab flex flex-col items-center gap-1 w-16">
                <svg class="w-7 h-7 tab-icon" viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/></svg>
                <span class="text-[10px] font-medium text-[#8E8E93]">Conversas</span>
            </button>
            <button onclick="switchTab('settings')" id="btn-settings" class="flex flex-col items-center gap-1 w-16">
                <svg class="w-7 h-7 tab-icon" viewBox="0 0 24 24"><path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58a.49.49 0 0 0 .12-.61l-1.92-3.32a.488.488 0 0 0-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54a.484.484 0 0 0-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.04.17 0 .4.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58a.49.49 0 0 0-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.04-.22 0-.45-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg>
                <span class="text-[10px] font-medium text-[#8E8E93]">Ajustes</span>
            </button>
        </nav>
    </div>

    <div id="chat-room" class="page page-enter z-40 flex flex-col h-full bg-[#E5DDD5]">
        <header class="h-16 bg-[#F2F2F7]/95 backdrop-blur border-b border-[#C6C6C8] flex items-center px-2 pt-2 sticky top-0 z-50">
            <button onclick="closeChat()" class="flex items-center text-[#007AFF] pr-3 h-full">
                <svg class="w-8 h-8" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
                <span class="text-[17px] -ml-1">Voltar</span>
            </button>
            <div class="flex-1 flex items-center gap-3 cursor-pointer" onclick="viewContactInfo()">
                <img id="chat_avatar" class="w-9 h-9 rounded-full bg-gray-300 object-cover border border-gray-200">
                <div class="flex flex-col justify-center h-full">
                    <h3 id="chat_name" class="font-semibold text-[16px] leading-tight">Nome</h3>
                    <span id="chat_status" class="text-[11px] text-gray-500 leading-tight">clique para info</span>
                </div>
            </div>
            <button class="text-[#007AFF] p-2"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg></button>
            <button class="text-[#007AFF] p-2"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/></svg></button>
        </header>

        <div id="msg-container" class="flex-1 overflow-y-auto chat-bg p-4 flex flex-col pb-4">
            </div>

        <div class="input-bar px-2 py-2 flex items-end gap-2 bg-[#F6F6F6] pb-safe">
            <button class="text-[#007AFF] p-2 mb-1"><svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg></button>
            
            <div class="flex-1 bg-white border border-[#C6C6C8] rounded-2xl min-h-[36px] flex items-center px-3 py-1 mb-1 shadow-sm">
                <input id="chat-input" class="w-full bg-transparent outline-none text-[17px] max-h-24 resize-none" placeholder="" onkeydown="handleTyping(event)">
            </div>
            
            <button onclick="handleSend()" id="send-btn" class="text-[#007AFF] p-2 mb-1 font-bold hidden">Enviar</button>
            <button onclick="toggleMic()" id="mic-btn" class="text-[#007AFF] p-2 mb-1"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"/></svg></button>
            <button class="text-[#007AFF] p-2 mb-1"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/></svg></button>
        </div>
    </div>

    <div id="new-chat-modal" class="fixed inset-0 z-[6000] hidden">
        <div class="absolute inset-0 modal-overlay" onclick="closeNewChatModal()"></div>
        <div class="absolute bottom-0 w-full bg-[#F2F2F7] rounded-t-2xl modal-content flex flex-col h-[90%]">
            <header class="h-14 flex items-center justify-between px-4 border-b border-[#C6C6C8] bg-[#F2F2F7] rounded-t-2xl">
                <button onclick="closeNewChatModal()" class="text-[#007AFF] text-[17px]">Cancelar</button>
                <span class="font-bold text-[17px]">Nova Conversa</span>
                <span class="w-10"></span>
            </header>
            <div class="p-4">
                <div class="bg-white px-4 py-2 rounded-xl flex items-center gap-2">
                    <span class="text-gray-500">Para:</span>
                    <input id="new-chat-input" class="flex-1 outline-none text-[17px]" placeholder="Nome do usu√°rio">
                </div>
                <button onclick="startChat()" class="mt-4 w-full bg-[#007AFF] text-white py-3 rounded-xl font-bold text-[17px]">Iniciar Conversa</button>
            </div>
        </div>
    </div>

    <div id="toast" class="fixed top-2 left-2 right-2 z-[7000] bg-white/90 backdrop-blur shadow-lg rounded-2xl p-4 transform -translate-y-32 transition duration-500 flex items-center gap-3 cursor-pointer border border-gray-200" onclick="clickToast()">
        <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/6/6b/WhatsApp.svg/1200px-WhatsApp.svg.png" class="w-10 h-10">
        <div class="flex-1 min-w-0">
            <h4 id="toast-title" class="font-bold text-sm truncate">WhatsApp</h4>
            <p id="toast-body" class="text-xs text-gray-500 truncate">Nova mensagem</p>
        </div>
    </div>

    <script>
        // CONFIG E VARI√ÅVEIS
        const socket = io();
        let currentUser = null;
        let activeChat = null;
        let audioRecorder = null, audioChunks = [];
        let typingTimeout = null;

        // --- SISTEMA DE AUTENTICA√á√ÉO ---
        window.onload = () => {
            const saved = localStorage.getItem('whats_clone_user');
            if (saved) {
                currentUser = JSON.parse(saved);
                enterApp();
            }
        };

        async function auth(endpoint) {
            const u = document.getElementById('u_auth').value.trim();
            const p = document.getElementById('p_auth').value.trim();
            if(!u || !p) return alert('Preencha os campos');
            
            try {
                const res = await fetch(`/${endpoint}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({username: u, password: p})
                });
                
                if(res.ok) {
                    if(endpoint === 'login') {
                        currentUser = await res.json();
                        localStorage.setItem('whats_clone_user', JSON.stringify(currentUser));
                        enterApp();
                    } else {
                        alert('Conta criada! Fa√ßa login.');
                        auth('login'); // Auto login attempt or just prompt
                    }
                } else {
                    alert('Erro na autentica√ß√£o');
                }
            } catch(e) { console.error(e); }
        }

        function enterApp() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            socket.emit('join', currentUser.username);
            updateProfileUI();
            loadChats();
        }

        function logout() {
            localStorage.removeItem('whats_clone_user');
            location.reload();
        }

        // --- INTERFACE E NAVEGA√á√ÉO ---
        function switchTab(tab) {
            // Esconde todas as abas
            ['chats', 'status', 'settings'].forEach(t => {
                document.getElementById(`tab-${t}`).classList.add('hidden');
                document.getElementById(`btn-${t}`).classList.remove('active-tab');
                document.getElementById(`btn-${t}`).querySelector('span').classList.remove('text-[#007AFF]');
                document.getElementById(`btn-${t}`).querySelector('span').classList.add('text-[#8E8E93]');
            });
            // Mostra atual
            document.getElementById(`tab-${tab}`).classList.remove('hidden');
            document.getElementById(`btn-${tab}`).classList.add('active-tab');
            document.getElementById(`btn-${tab}`).querySelector('span').classList.add('text-[#007AFF]');
            document.getElementById(`btn-${tab}`).querySelector('span').classList.remove('text-[#8E8E93]');
            
            if(tab === 'chats') loadChats();
            if(tab === 'status') loadStatus();
        }

        function updateProfileUI() {
            const pic = currentUser.avatar && currentUser.avatar.length > 10 ? currentUser.avatar : `https://ui-avatars.com/api/?name=${currentUser.username}&background=random`;
            document.getElementById('settings_avatar').src = pic;
            document.getElementById('my_status_avatar').src = pic;
            document.getElementById('settings_name').innerText = currentUser.username;
            document.getElementById('settings_bio').innerText = currentUser.bio || "Sem recado";
        }

        // --- LISTA DE CONVERSAS ---
        async function loadChats() {
            const res = await fetch(`/chats/${currentUser.username}`);
            const chats = await res.json();
            const list = document.getElementById('chat-list');
            
            if(chats.length === 0) {
                list.innerHTML = '<div class="text-center mt-10 text-gray-400">Nenhuma conversa iniciada</div>';
                return;
            }

            list.innerHTML = chats.map(c => {
                const pic = c.avatar && c.avatar.length > 10 ? c.avatar : `https://ui-avatars.com/api/?name=${c.contact}&background=random`;
                const isMe = c.last_sender === currentUser.username;
                
                // Formata√ß√£o da √∫ltima mensagem
                let msgPreview = c.last_msg;
                if(c.last_type === 'audio') msgPreview = 'üéµ √Åudio';
                if(isMe) msgPreview = `You: ${msgPreview}`;

                // Status ticks
                let statusIcon = '';
                if(isMe) {
                    const color = c.last_status == 2 ? '#34C759' : '#8E8E93'; // Azul (lido) ou Cinza
                    statusIcon = `<svg class="w-4 h-4 mr-1 inline" style="color:${color}" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>`;
                    if(c.last_status == 2) statusIcon = `<svg class="w-4 h-4 mr-1 inline text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>`;
                }

                return `
                <div onclick="openChat('${c.contact}')" class="flex items-center gap-3 py-3 pr-4 border-b border-[#C6C6C8] cursor-pointer hover:bg-gray-50 transition active:bg-[#E5E5EA]">
                    <img src="${pic}" class="w-14 h-14 rounded-full object-cover border border-gray-200 bg-gray-200 shrink-0">
                    <div class="flex-1 min-w-0">
                        <div class="flex justify-between items-baseline mb-1">
                            <h3 class="font-bold text-[17px] truncate">${c.contact}</h3>
                            <span class="text-[14px] text-gray-400 ${c.unread > 0 ? 'text-[#007AFF] font-bold' : ''}">${c.last_time || ''}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <p class="text-[15px] text-gray-500 truncate w-5/6 leading-tight">
                                ${statusIcon} ${msgPreview || ''}
                            </p>
                            ${c.unread > 0 ? `<div class="bg-[#007AFF] text-white text-[12px] font-bold px-2 py-0.5 rounded-full min-w-[20px] text-center">${c.unread}</div>` : ''}
                        </div>
                    </div>
                </div>`;
            }).join('');
        }

        // --- CHAT ROOM LOGIC ---
        async function openChat(contact) {
            activeChat = contact;
            
            // UI SETUP
            document.getElementById('chat-room').classList.remove('page-enter');
            document.getElementById('chat-room').classList.add('page-active');
            document.getElementById('chat_name').innerText = contact;
            
            // Get Info
            const uInfo = await fetch(`/user/${contact}`).then(r => r.json());
            const pic = uInfo.avatar && uInfo.avatar.length > 10 ? uInfo.avatar : `https://ui-avatars.com/api/?name=${contact}&background=random`;
            document.getElementById('chat_avatar').src = pic;
            
            // Load Msgs
            await loadMessages();
            socket.emit('mark_read', { s: activeChat, r: currentUser.username });
        }

        function closeChat() {
            document.getElementById('chat-room').classList.remove('page-active');
            document.getElementById('chat-room').classList.add('page-enter');
            activeChat = null;
            loadChats(); // Refresh list to update read status/order
        }

        async function loadMessages() {
            if(!activeChat) return;
            const msgs = await fetch(`/messages/${currentUser.username}/${activeChat}`).then(r => r.json());
            const container = document.getElementById('msg-container');
            
            container.innerHTML = msgs.map(m => {
                const isMe = m.s === currentUser.username;
                let contentHTML = '';
                
                if(m.type === 'audio') {
                    // Simples Audio Player
                    contentHTML = `
                    <div class="flex items-center gap-2 min-w-[200px]">
                        <button onclick="playAudio(this, '${m.c}')" class="text-gray-500 hover:text-black">
                             <svg class="w-8 h-8 play-icon" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd"/></svg>
                        </button>
                        <div class="h-1 bg-gray-300 rounded-full flex-1 overflow-hidden">
                            <div class="h-full bg-gray-500 w-0 transition-all duration-300 progress-bar"></div>
                        </div>
                        <span class="text-xs font-mono text-gray-500">Audio</span>
                    </div>`;
                } else {
                    contentHTML = m.c;
                }

                const statusCheck = isMe ? 
                    `<span class="${m.status == 2 ? 'text-blue-500' : 'text-gray-400'} text-[10px] ml-1">
                        ${m.status == 0 ? '‚úì' : '‚úì‚úì'}
                    </span>` : '';

                return `
                <div class="msg-bubble ${isMe ? 'msg-me' : 'msg-them'}">
                    <div class="text-sm break-words">${contentHTML}</div>
                    <div class="msg-info">
                        <span>${m.f_time}</span>
                        ${statusCheck}
                    </div>
                </div>`;
            }).join('');
            
            scrollToBottom();
        }

        function scrollToBottom() {
            const c = document.getElementById('msg-container');
            c.scrollTop = c.scrollHeight;
        }

        // --- ENVIAR MENSAGENS ---
        function handleTyping(e) {
            const btn = document.getElementById('send-btn');
            const mic = document.getElementById('mic-btn');
            
            if(e.target.value.length > 0) {
                btn.classList.remove('hidden');
                mic.classList.add('hidden');
            } else {
                btn.classList.add('hidden');
                mic.classList.remove('hidden');
            }

            if(e.key === 'Enter') {
                handleSend();
            }

            // Emit Typing
            socket.emit('typing', { to: activeChat, isTyping: true });
            if(typingTimeout) clearTimeout(typingTimeout);
            typingTimeout = setTimeout(() => socket.emit('typing', { to: activeChat, isTyping: false }), 2000);
        }

        function handleSend() {
            const input = document.getElementById('chat-input');
            const txt = input.value.trim();
            if(!txt || !activeChat) return;
            
            socket.emit('send_msg', {
                s: currentUser.username,
                r: activeChat,
                c: txt,
                type: 'text'
            });
            
            input.value = '';
            document.getElementById('send-btn').classList.add('hidden');
            document.getElementById('mic-btn').classList.remove('hidden');
            
            // Otimista: Adiciona no DOM imediatamente
            const container = document.getElementById('msg-container');
            const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            container.innerHTML += `
                <div class="msg-bubble msg-me opacity-70">
                    <div class="text-sm break-words">${txt}</div>
                    <div class="msg-info"><span>${time}</span> <span>üïí</span></div>
                </div>`;
            scrollToBottom();
        }

        // --- AUDIO ---
        async function toggleMic() {
            if(!audioRecorder) {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    audioRecorder = new MediaRecorder(stream);
                    audioChunks = [];
                    
                    audioRecorder.ondataavailable = e => audioChunks.push(e.data);
                    
                    audioRecorder.onstop = () => {
                        const blob = new Blob(audioChunks, { type: 'audio/webm' });
                        const reader = new FileReader();
                        reader.readAsDataURL(blob);
                        reader.onloadend = () => {
                             socket.emit('send_msg', {
                                s: currentUser.username,
                                r: activeChat,
                                c: reader.result,
                                type: 'audio'
                            });
                        };
                        document.getElementById('chat-input').placeholder = "Mensagem";
                    };

                    audioRecorder.start();
                    document.getElementById('chat-input').placeholder = "Gravando... (Toque novamente para enviar)";
                    document.getElementById('mic-btn').innerHTML = '<div class="w-6 h-6 rounded-full bg-red-500 animate-pulse"></div>'; // Icone gravando
                } catch(e) { alert("Microfone bloqueado ou indispon√≠vel"); }
            } else {
                audioRecorder.stop();
                audioRecorder = null;
                document.getElementById('mic-btn').innerHTML = '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"/></svg>';
            }
        }

        function playAudio(btn, src) {
            const audio = new Audio(src);
            audio.play();
            const bar = btn.nextElementSibling.firstElementChild;
            
            audio.ontimeupdate = () => {
                const pct = (audio.currentTime / audio.duration) * 100;
                bar.style.width = pct + '%';
            };
            audio.onended = () => {
                bar.style.width = '0%';
            };
        }

        // --- SOCKET LISTENERS ---
        socket.on('new_msg', (m) => {
            if(activeChat === m.s) {
                loadMessages();
                socket.emit('mark_read', { s: activeChat, r: currentUser.username });
            } else {
                showToast(`Nova mensagem de ${m.s}`, m.s);
                loadChats();
            }
        });

        socket.on('msg_sent_ok', () => {
            if(activeChat) loadMessages(); // Refresh para tirar o reloginho
        });

        socket.on('typing_status', (data) => {
            if(activeChat === data.from) {
                document.getElementById('chat_status').innerText = data.isTyping ? "digitando..." : "Online";
                document.getElementById('chat_status').className = data.isTyping ? "text-[12px] text-[#007AFF] font-bold" : "text-[11px] text-gray-500";
            }
        });

        socket.on('msgs_read_update', (data) => {
            if(activeChat === data.reader) loadMessages(); // Atualiza os ticks azuis
            loadChats();
        });

        // --- UTILS (Modal, Toast, Perfil) ---
        function openNewChatModal() { document.getElementById('new-chat-modal').classList.remove('hidden'); }
        function closeNewChatModal() { document.getElementById('new-chat-modal').classList.add('hidden'); }
        
        async function startChat() {
            const u = document.getElementById('new-chat-input').value.trim();
            if(!u || u === currentUser.username) return alert("Usu√°rio inv√°lido");
            const res = await fetch(`/user/${u}`).then(r => r.json());
            if(res.username) {
                closeNewChatModal();
                openChat(u);
            } else {
                alert("Usu√°rio n√£o encontrado");
            }
        }

        function showToast(title, sender) {
            const t = document.getElementById('toast');
            document.getElementById('toast-title').innerText = sender;
            document.getElementById('toast-body').innerText = title;
            t.classList.remove('-translate-y-32');
            t.onclick = () => { 
                t.classList.add('-translate-y-32'); 
                switchTab('chats'); // Garante que est√° na tab certa
                openChat(sender); 
            };
            setTimeout(() => t.classList.add('-translate-y-32'), 4000);
        }

        async function updateAvatar(e) {
            const f = e.target.files[0];
            if(!f) return;
            const r = new FileReader();
            r.onload = async () => {
                await fetch('/update-profile', {
                    method: 'POST',
                    headers: {'Content-Type':'application/json'},
                    body: JSON.stringify({username: currentUser.username, bio: currentUser.bio, avatar: r.result})
                });
                currentUser.avatar = r.result;
                localStorage.setItem('whats_clone_user', JSON.stringify(currentUser));
                updateProfileUI();
            };
            r.readAsDataURL(f);
        }

        // Status Logic
        async function postStatus(e) {
            const f = e.target.files[0];
            if(!f) return;
            const r = new FileReader();
            r.onload = async () => {
                await fetch('/post-status', {
                    method:'POST',
                    headers:{'Content-Type':'application/json'},
                    body: JSON.stringify({username: currentUser.username, content: r.result})
                });
                alert("Status postado!");
                loadStatus();
            };
            r.readAsDataURL(f);
        }

        async function loadStatus() {
            const res = await fetch('/get-status').then(r => r.json());
            document.getElementById('status-list').innerHTML = res.map(s => `
                <div class="flex items-center gap-3 py-3 pr-4 border-b border-[#C6C6C8]">
                    <div class="p-[2px] rounded-full border-2 border-[#007AFF]">
                        <img src="${s.avatar}" class="w-12 h-12 rounded-full object-cover">
                    </div>
                    <div>
                        <h3 class="font-bold text-[16px]">${s.username}</h3>
                        <p class="text-xs text-gray-500">hoje</p>
                    </div>
                </div>
            `).join('');
        }
    </script>
</body>
</html>
