<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>WhatsApp Black</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/socket.io/socket.io.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* --- CONFIGURAÇÃO TEMA BLACK & RED --- */
        :root { 
            --bg-app: #000000; 
            --bg-header: #1C1C1E;
            --bg-item: #1C1C1E;
            --accent-color: #FF3B30; /* Vermelho iOS */
            --text-primary: #FFFFFF;
            --text-secondary: #8E8E93;
            --bubble-me: #3E1010; /* Vermelho escuro para minhas msgs */
            --bubble-them: #2C2C2E; /* Cinza para eles */
            --separator: #38383A;
        }

        body, html { height: 100%; width: 100%; overflow: hidden; background: var(--bg-app); color: var(--text-primary); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; -webkit-tap-highlight-color: transparent; }
        
        /* Utilitários */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .pt-safe { padding-top: env(safe-area-inset-top); }

        /* Transições de Tela (Slide iOS) */
        .screen {
            position: absolute; inset: 0; background: var(--bg-app);
            transition: transform 0.35s cubic-bezier(0.32, 0.72, 0, 1);
            display: flex; flex-direction: column; z-index: 10;
        }
        .screen-hidden { transform: translateX(100%); z-index: 20; }
        .screen-active { transform: translateX(0); }
        
        /* Chat Background Dark */
        #chat-room { 
            background-color: #0b0b0b; 
            background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png');
            background-blend-mode: overlay; /* Deixa o background escuro */
            z-index: 50;
        }

        /* Balões */
        .msg-row { display: flex; width: 100%; margin-bottom: 2px; padding: 0 10px; }
        .msg-bubble { 
            max-width: 75%; padding: 6px 10px; font-size: 16px; 
            border-radius: 8px; position: relative; line-height: 1.3;
        }
        .msg-me { justify-content: flex-end; }
        .msg-me .msg-bubble { background: var(--bubble-me); color: white; border-radius: 18px 18px 4px 18px; }
        .msg-them { justify-content: flex-start; }
        .msg-them .msg-bubble { background: var(--bubble-them); color: white; border-radius: 18px 18px 18px 4px; }
        
        .msg-meta { font-size: 11px; color: rgba(255,255,255,0.5); display: flex; justify-content: flex-end; margin-top: 4px; gap: 4px; align-items: center; }
        
        /* Navegação */
        .nav-item { color: #555; transition: color 0.2s; }
        .nav-item.active { color: var(--accent-color); }
        
        /* Inputs Customizados */
        .input-dark {
            background: #2C2C2E; color: white; border: none; outline: none;
        }
        .search-bar { background: #1C1C1E; }
    </style>
</head>
<body>

    <div id="login-screen" class="fixed inset-0 bg-black z-[100] flex flex-col items-center justify-center p-8">
        <div class="w-24 h-24 rounded-2xl flex items-center justify-center mb-6 border-2 border-[#FF3B30]">
            <i class="fa-brands fa-whatsapp text-[#FF3B30] text-5xl"></i>
        </div>
        <h1 class="text-2xl font-bold mb-8 text-white">Login <span class="text-[#FF3B30]">Black</span></h1>
        
        <div class="w-full max-w-sm space-y-4">
            <input id="u_auth" type="text" placeholder="Usuário" class="w-full bg-[#1C1C1E] text-white p-4 rounded-xl outline-none focus:ring-1 focus:ring-red-500">
            <input id="p_auth" type="password" placeholder="Senha" class="w-full bg-[#1C1C1E] text-white p-4 rounded-xl outline-none focus:ring-1 focus:ring-red-500">
            
            <button onclick="handleAuth('login')" class="w-full bg-[#FF3B30] active:bg-[#d63026] text-white py-4 rounded-xl font-bold text-lg">Entrar</button>
            <button onclick="handleAuth('register')" class="w-full text-[#FF3B30] font-medium py-2">Criar conta</button>
        </div>
        <p id="auth-error" class="text-red-500 mt-4 text-sm font-medium hidden"></p>
    </div>

    <div id="main-app" class="hidden h-full w-full relative">
        
        <div id="tab-chats" class="screen flex flex-col">
            <header class="bg-[#1C1C1E] border-b border-[#38383A] pt-12 px-4 pb-3 flex justify-between items-end h-[100px] shrink-0 sticky top-0 z-20">
                <button class="text-[#FF3B30] text-[17px] font-medium">Editar</button>
                <h1 class="font-bold text-[20px] text-white">Conversas</h1>
                <button onclick="openModal('new-chat-modal')" class="text-[#FF3B30]">
                    <i class="fa-regular fa-pen-to-square text-xl"></i>
                </button>
            </header>

            <div class="flex-1 overflow-y-auto bg-black">
                <div class="px-4 py-2">
                    <div class="bg-[#1C1C1E] rounded-lg px-3 py-2 flex items-center gap-2">
                        <i class="fa-solid fa-magnifying-glass text-gray-500"></i>
                        <input placeholder="Pesquisar" class="bg-transparent w-full outline-none text-sm text-white placeholder-gray-500">
                    </div>
                </div>

                <div id="friend-requests-bar" class="hidden px-4 py-3 border-b border-[#38383A] cursor-pointer bg-[#110505]" onclick="openModal('requests-modal')">
                    <div class="flex justify-between items-center text-[#FF3B30]">
                        <span class="font-medium">Solicitações de Amizade</span>
                        <span id="req-count" class="bg-[#FF3B30] text-white text-xs font-bold px-2 py-0.5 rounded-full">0</span>
                    </div>
                </div>

                <div id="chat-list" class="pl-4 divide-y divide-[#38383A]"></div>
            </div>
        </div>

        <div id="tab-status" class="screen screen-hidden bg-black">
            <header class="bg-[#1C1C1E] border-b border-[#38383A] pt-12 pb-3 px-4 h-[100px] flex items-end justify-center">
                <h1 class="font-bold text-[17px] text-white">Status</h1>
            </header>
            <div class="p-4">
                <div class="flex items-center gap-4 mb-8 cursor-pointer relative" onclick="document.getElementById('status_file').click()">
                    <div class="relative">
                        <img id="my_status_pic" class="w-14 h-14 rounded-full object-cover border border-[#38383A]">
                        <div class="absolute bottom-0 right-0 bg-[#FF3B30] text-white w-5 h-5 rounded-full flex items-center justify-center text-xs border-2 border-black">+</div>
                    </div>
                    <div>
                        <h3 class="font-bold text-white">Meu Status</h3>
                        <p class="text-gray-500 text-sm">Adicionar ao meu status</p>
                    </div>
                    <input type="file" id="status_file" hidden accept="image/*" onchange="postStatus(event)">
                </div>

                <div class="text-xs font-bold text-gray-500 uppercase mb-4">Atualizações Recentes</div>
                <div id="status-list" class="space-y-6"></div>
            </div>
        </div>

        <div id="tab-settings" class="screen screen-hidden bg-black">
            <header class="bg-[#1C1C1E] border-b border-[#38383A] pt-12 pb-3 px-4 h-[100px] flex items-end justify-center">
                <h1 class="font-bold text-[17px] text-white">Ajustes</h1>
            </header>
            <div class="mt-8">
                <div class="bg-[#1C1C1E] border-y border-[#38383A] flex items-center p-4 gap-4" onclick="document.getElementById('avatar_file').click()">
                    <img id="settings_avatar" class="w-16 h-16 rounded-full bg-gray-700 object-cover">
                    <div class="flex-1">
                        <h2 id="settings_name" class="text-xl font-semibold text-white">User</h2>
                        <p class="text-gray-500 text-sm">Toque para mudar foto</p>
                    </div>
                    <input type="file" id="avatar_file" hidden accept="image/*" onchange="updateProfilePic(event)">
                </div>
                
                <div class="mt-8 bg-[#1C1C1E] border-y border-[#38383A] px-4">
                    <div class="py-3">
                        <label class="text-xs text-[#FF3B30] font-bold uppercase">Recado</label>
                        <input id="settings_bio" class="w-full mt-1 text-[17px] outline-none bg-transparent text-white" onblur="saveBio(this.value)">
                    </div>
                </div>

                <div class="mt-8">
                    <button onclick="logout()" class="w-full bg-[#1C1C1E] p-4 text-[#FF3B30] text-lg border-y border-[#38383A] font-medium">Sair</button>
                </div>
            </div>
        </div>

        <nav class="absolute bottom-0 w-full bg-[#1C1C1E]/95 backdrop-blur border-t border-[#38383A] h-[83px] flex justify-around pt-2 pb-safe z-40">
            <button onclick="switchTab('status')" id="btn-status" class="nav-item flex flex-col items-center gap-1 w-16">
                <i class="fa-regular fa-circle-dot text-2xl mb-0.5"></i>
                <span class="text-[10px] font-medium">Status</span>
            </button>
            <button onclick="switchTab('chats')" id="btn-chats" class="nav-item active flex flex-col items-center gap-1 w-16">
                <i class="fa-brands fa-whatsapp text-2xl mb-0.5"></i>
                <span class="text-[10px] font-medium">Conversas</span>
            </button>
            <button onclick="switchTab('settings')" id="btn-settings" class="nav-item flex flex-col items-center gap-1 w-16">
                <i class="fa-solid fa-gear text-2xl mb-0.5"></i>
                <span class="text-[10px] font-medium">Ajustes</span>
            </button>
        </nav>

        <div id="chat-room" class="screen screen-hidden flex flex-col h-full">
            <header class="bg-[#1C1C1E]/95 backdrop-blur border-b border-[#38383A] pt-safe-top h-[100px] flex items-end px-2 pb-2 shrink-0 z-50 shadow-sm">
                <button onclick="closeChat()" class="flex items-center text-[#FF3B30] pr-2 pb-2 h-10 z-10">
                    <i class="fa-solid fa-chevron-left text-xl mr-1"></i>
                    <span class="text-[17px]">Voltar</span>
                </button>
                <div class="absolute inset-x-0 bottom-2 flex flex-col items-center justify-center cursor-pointer pointer-events-none">
                    <div class="flex flex-col items-center pointer-events-auto" onclick="openContactInfo()">
                        <h3 id="chat_name" class="font-semibold text-[16px] leading-tight text-white">--</h3>
                        <span id="chat_status" class="text-[12px] text-gray-400 leading-tight h-4">Offline</span>
                    </div>
                </div>
                <div class="flex-1 flex justify-end pb-2 pr-2">
                    <img id="chat_avatar_header" class="w-9 h-9 rounded-full bg-gray-700 object-cover border border-[#38383A]">
                </div>
            </header>

            <div id="msg-container" class="flex-1 overflow-y-auto p-4 pb-4"></div>

            <div class="bg-[#1C1C1E] border-t border-[#38383A] px-2 py-2 flex items-end gap-2 pb-safe shrink-0 z-50">
                <button onclick="document.getElementById('media_input').click()" class="text-[#FF3B30] p-2 mb-1">
                    <i class="fa-solid fa-plus text-xl"></i>
                </button>
                <input type="file" id="media_input" hidden accept="image/*,video/*" onchange="handleMediaSend(event)">

                <div class="flex-1 bg-[#2C2C2E] rounded-2xl min-h-[36px] flex items-center px-3 py-1 mb-1">
                    <input id="chat-input" class="w-full bg-transparent outline-none text-[16px] text-white max-h-24 py-1" placeholder="" onkeydown="handleInputKey(event)" oninput="handleTypingInput()">
                </div>
                
                <button onclick="sendMessage()" id="send-btn" class="bg-[#FF3B30] rounded-full w-9 h-9 flex items-center justify-center text-white mb-1 hidden transition-all">
                    <i class="fa-solid fa-paper-plane text-sm"></i>
                </button>
                <button onclick="toggleMic()" id="mic-btn" class="text-[#FF3B30] p-2 mb-1 transition-all">
                    <i class="fa-solid fa-microphone text-lg"></i>
                </button>
            </div>
        </div>

    </div>

    <div id="story-viewer" class="fixed inset-0 z-[300] hidden bg-black flex flex-col">
        <div class="h-1 bg-gray-700 w-full flex mb-2 mt-safe-top px-2">
            <div class="h-full bg-white w-full animate-loader"></div>
        </div>
        <div class="flex-1 flex items-center justify-center relative">
            <img id="story-img" class="max-h-full max-w-full object-contain">
            <div class="absolute top-4 left-4 flex items-center gap-2">
                <img id="story-avatar" class="w-10 h-10 rounded-full border border-white">
                <span id="story-user" class="text-white font-bold shadow-black drop-shadow-md">User</span>
            </div>
            <button onclick="document.getElementById('story-viewer').classList.add('hidden')" class="absolute top-4 right-4 text-white text-3xl">&times;</button>
        </div>
    </div>

    <div id="new-chat-modal" class="fixed inset-0 z-[200] hidden bg-black/80 backdrop-blur-sm">
        <div class="absolute inset-x-0 bottom-0 top-20 bg-[#1C1C1E] rounded-t-2xl flex flex-col overflow-hidden">
            <div class="bg-[#1C1C1E] p-4 flex justify-between items-center border-b border-[#38383A]">
                <button onclick="closeModal('new-chat-modal')" class="text-[#FF3B30] text-[17px]">Cancelar</button>
                <span class="font-bold text-[17px] text-white">Nova Conversa</span>
                <span class="w-14"></span>
            </div>
            <div class="p-4">
                <div class="flex gap-2">
                    <input id="search-user-input" placeholder="Buscar usuário..." class="flex-1 bg-[#2C2C2E] text-white p-3 rounded-xl outline-none">
                    <button onclick="searchUsers()" class="bg-[#FF3B30] text-white px-6 rounded-xl font-bold">Buscar</button>
                </div>
                <div id="search-results" class="mt-6 divide-y divide-[#38383A]"></div>
            </div>
        </div>
    </div>

    <div id="contact-info-modal" class="fixed inset-0 z-[200] hidden bg-black/70" onclick="this.classList.add('hidden')">
        <div class="absolute inset-x-0 bottom-0 bg-[#1C1C1E] rounded-t-2xl p-6 flex flex-col items-center pb-safe border-t border-[#FF3B30]" onclick="event.stopPropagation()">
            <img id="info_avatar" class="w-24 h-24 rounded-full bg-gray-700 object-cover mb-4 border-2 border-[#FF3B30]">
            <h2 id="info_name" class="text-2xl font-bold mb-1 text-white">Nome</h2>
            <p id="info_seen" class="text-[#FF3B30] text-sm mb-4 font-medium">--</p>
            <div class="w-full bg-[#2C2C2E] rounded-xl p-4 mb-4">
                <span class="text-xs text-gray-400 uppercase font-bold">Recado</span>
                <p id="info_bio" class="text-white mt-1">Sem recado.</p>
            </div>
        </div>
    </div>

    <div id="requests-modal" class="fixed inset-0 z-[200] hidden bg-black/80">
        <div class="absolute inset-x-0 bottom-0 top-40 bg-[#1C1C1E] rounded-t-2xl flex flex-col">
            <div class="bg-[#1C1C1E] p-4 flex justify-between items-center border-b border-[#38383A]">
                <button onclick="closeModal('requests-modal')" class="text-[#FF3B30]">Fechar</button>
                <span class="font-bold text-white">Solicitações</span>
                <span class="w-10"></span>
            </div>
            <div id="requests-list" class="p-4 overflow-y-auto flex-1"></div>
        </div>
    </div>

    <script>
        const socket = io();
        let currentUser = null;
        let activeChat = null;
        let typingTimeout = null;

        // --- INIT ---
        window.onload = () => {
            const saved = localStorage.getItem('whats_black_user');
            if (saved) {
                currentUser = JSON.parse(saved);
                initializeAfterAuth();
            }
        };

        async function api(endpoint, method = 'GET', body = null) {
            const options = { method, headers: { 'Content-Type': 'application/json' } };
            if (body) options.body = JSON.stringify(body);
            try { return await fetch(endpoint, options).then(r => r.ok ? r.json() : null); } 
            catch (e) { console.error(e); return null; }
        }

        // --- AUTH ---
        async function handleAuth(type) {
            const u = document.getElementById('u_auth').value.trim();
            const p = document.getElementById('p_auth').value.trim();
            if (!u || !p) return alert("Preencha tudo");

            const endpoint = type === 'login' ? '/auth/login' : '/auth/register';
            const res = await fetch(endpoint, {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ username: u, password: p })
            });

            if (res.ok) {
                if (type === 'register') {
                    alert("Conta criada! Entre agora.");
                    handleAuth('login');
                } else {
                    currentUser = await res.json();
                    localStorage.setItem('whats_black_user', JSON.stringify(currentUser));
                    initializeAfterAuth();
                }
            } else alert("Erro de autenticação");
        }

        function initializeAfterAuth() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            socket.emit('join', currentUser.username);
            updateMyProfileUI();
            loadChatList();
            checkFriendRequests();
            setupSocketListeners();
        }

        function logout() {
            localStorage.removeItem('whats_black_user');
            location.reload();
        }

        // --- SOCKETS ---
        function setupSocketListeners() {
            socket.on('new_msg', (msg) => {
                if (activeChat === msg.s) {
                    renderMessage(msg);
                    socket.emit('mark_read', { s: msg.s, r: currentUser.username });
                    scrollToBottom();
                }
                loadChatList();
            });

            socket.on('typing_status', (data) => {
                if (activeChat === data.from) {
                    const el = document.getElementById('chat_status');
                    el.innerText = data.isTyping ? "digitando..." : "Online";
                    el.style.color = data.isTyping ? "#FF3B30" : "#8E8E93";
                    if(!data.isTyping) socket.emit('get_status_detailed', activeChat);
                }
            });

            socket.on('status_result', (data) => {
                if (activeChat === data.username) updateHeaderStatus(data);
            });
            
            socket.on('contact_status_update', (data) => {
                if (activeChat === data.username) updateHeaderStatus(data);
            });
        }

        function updateHeaderStatus(data) {
            const el = document.getElementById('chat_status');
            if(data.status === 'online') {
                el.innerText = 'Online';
                el.className = 'text-[12px] text-[#FF3B30] font-bold leading-tight h-4';
            } else {
                const date = new Date(data.last_seen);
                const timeStr = date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                el.innerText = `Visto hoje às ${timeStr}`;
                el.className = 'text-[12px] text-gray-500 leading-tight h-4';
            }
        }

        // --- CHATS ---
        async function loadChatList() {
            const chats = await api(`/api/chats/${currentUser.username}`);
            const list = document.getElementById('chat-list');
            list.innerHTML = '';
            
            if(!chats || chats.length === 0) {
                list.innerHTML = '<div class="text-center text-gray-600 mt-10">Sem conversas</div>'; return;
            }

            chats.forEach(chat => {
                const avatar = chat.avatar || `https://ui-avatars.com/api/?name=${chat.contact}&background=random`;
                const unread = chat.unread > 0 
                    ? `<div class="bg-[#FF3B30] text-white text-xs font-bold w-5 h-5 flex items-center justify-center rounded-full">${chat.unread}</div>` 
                    : '';
                
                list.innerHTML += `
                    <div onclick="openChat('${chat.contact}', '${avatar}')" class="flex items-center gap-3 py-3 pr-4 cursor-pointer hover:bg-[#111]">
                        <img src="${avatar}" class="w-14 h-14 rounded-full object-cover">
                        <div class="flex-1 min-w-0">
                            <div class="flex justify-between items-baseline">
                                <h3 class="font-bold text-white text-[17px]">${chat.contact}</h3>
                                <span class="text-[14px] ${chat.unread ? 'text-[#FF3B30]' : 'text-gray-500'}">${formatTime(chat.last_time)}</span>
                            </div>
                            <div class="flex justify-between items-center mt-1">
                                <p class="text-gray-400 text-[15px] truncate flex-1">${chat.last_msg || 'Nova conversa'}</p>
                                ${unread}
                            </div>
                        </div>
                    </div>
                `;
            });
        }

        async function openChat(username, avatar) {
            activeChat = username;
            document.getElementById('chat_name').innerText = username;
            document.getElementById('chat_avatar_header').src = avatar;
            
            const room = document.getElementById('chat-room');
            room.classList.remove('screen-hidden');
            room.classList.add('screen-active');

            const msgs = await api(`/api/messages/${currentUser.username}/${username}`);
            document.getElementById('msg-container').innerHTML = '';
            msgs.forEach(renderMessage);
            scrollToBottom();
            
            socket.emit('mark_read', { s: username, r: currentUser.username });
            socket.emit('get_status_detailed', username);
            loadChatList();
        }

        function closeChat() {
            const room = document.getElementById('chat-room');
            room.classList.add('screen-hidden');
            room.classList.remove('screen-active');
            activeChat = null;
            loadChatList();
        }

        function renderMessage(msg) {
            const isMe = msg.s === currentUser.username;
            const container = document.getElementById('msg-container');
            
            let content = `<span class="break-words whitespace-pre-wrap">${msg.c}</span>`;
            if (msg.type === 'image') content = `<img src="${msg.c}" class="rounded-lg max-w-full">`;
            if (msg.type === 'audio') content = `<audio src="${msg.c}" controls class="h-8 w-[200px]"></audio>`;

            const div = document.createElement('div');
            div.className = `msg-row ${isMe ? 'msg-me' : 'msg-them'}`;
            div.innerHTML = `
                <div class="msg-bubble shadow-sm">
                    ${content}
                    <div class="msg-meta">
                        ${new Date(msg.time).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}
                        ${isMe ? '<i class="fa-solid fa-check-double text-[#FF3B30]"></i>' : ''}
                    </div>
                </div>
            `;
            container.appendChild(div);
        }

        function sendMessage() {
            const input = document.getElementById('chat-input');
            const txt = input.value.trim();
            if(!txt) return;

            const payload = { s: currentUser.username, r: activeChat, c: txt, type: 'text' };
            socket.emit('send_msg', payload);
            renderMessage({...payload, time: new Date(), status: 0});
            scrollToBottom();
            input.value = '';
            handleTypingInput();
        }

        // --- TYPING & UTILS ---
        function handleTypingInput() {
            const val = document.getElementById('chat-input').value;
            const hasText = val.length > 0;
            document.getElementById('mic-btn').classList.toggle('hidden', hasText);
            document.getElementById('send-btn').classList.toggle('hidden', !hasText);
            
            if(activeChat) {
                socket.emit('typing', { to: activeChat, isTyping: true });
                clearTimeout(typingTimeout);
                typingTimeout = setTimeout(() => socket.emit('typing', { to: activeChat, isTyping: false }), 2000);
            }
        }
        
        function scrollToBottom() {
            const c = document.getElementById('msg-container');
            c.scrollTop = c.scrollHeight;
        }

        // --- STATUS / STORIES (FIXED) ---
        async function loadStatus() {
            const list = document.getElementById('status-list');
            list.innerHTML = '<div class="text-gray-500 text-center">Carregando...</div>';
            
            const stories = await api(`/api/stories/${currentUser.username}`);
            list.innerHTML = '';

            if(!stories || stories.length === 0) {
                list.innerHTML = '<div class="text-gray-600 text-center text-sm py-4">Nenhum status recente.</div>';
                return;
            }

            // Agrupa stories por usuário visualmente
            const uniqueUsers = {};
            stories.forEach(s => {
                if(!uniqueUsers[s.username]) uniqueUsers[s.username] = s;
            });

            Object.values(uniqueUsers).forEach(s => {
                const avatar = s.avatar || `https://ui-avatars.com/api/?name=${s.username}`;
                // Quando clicar, abre o visualizador com a imagem do story
                const item = document.createElement('div');
                item.className = "flex items-center gap-3 py-2 cursor-pointer";
                item.onclick = () => openStoryViewer(s.content, s.username, avatar);
                item.innerHTML = `
                    <div class="p-[2px] rounded-full border-2 border-[#FF3B30]">
                        <img src="${avatar}" class="w-14 h-14 rounded-full object-cover border-2 border-black">
                    </div>
                    <div>
                        <h3 class="font-bold text-white">${s.username}</h3>
                        <p class="text-xs text-gray-500">${formatTime(s.time)}</p>
                    </div>
                `;
                list.appendChild(item);
            });
        }

        async function postStatus(e) {
            const file = e.target.files[0];
            if(!file) return;
            
            const reader = new FileReader();
            reader.onload = async () => {
                // Envia para o servidor
                await api('/api/story', 'POST', {
                    username: currentUser.username,
                    content: reader.result, // Base64 da imagem
                    type: 'image',
                    caption: '',
                    bg_color: '#000000'
                });
                alert("Status publicado!");
                loadStatus(); // Recarrega lista
            };
            reader.readAsDataURL(file);
        }

        function openStoryViewer(imgSrc, username, avatar) {
            const viewer = document.getElementById('story-viewer');
            document.getElementById('story-img').src = imgSrc;
            document.getElementById('story-user').innerText = username;
            document.getElementById('story-avatar').src = avatar;
            viewer.classList.remove('hidden');
            
            // Auto close after 5s
            setTimeout(() => viewer.classList.add('hidden'), 5000);
        }

        // --- AMIZADE ---
        async function searchUsers() {
            const val = document.getElementById('search-user-input').value;
            const res = await api(`/api/search/${val}`);
            const div = document.getElementById('search-results');
            div.innerHTML = '';
            if(res) res.forEach(u => {
                if(u.username === currentUser.username) return;
                div.innerHTML += `
                    <div class="flex justify-between items-center py-3">
                        <span class="text-white font-bold">${u.username}</span>
                        <button onclick="addFriend('${u.username}', this)" class="text-[#FF3B30] text-sm font-bold">Adicionar</button>
                    </div>`;
            });
        }

        async function addFriend(to, btn) {
            await api('/api/friend-request', 'POST', { from: currentUser.username, to });
            socket.emit('send_friend_request', { from: currentUser.username, to });
            btn.innerText = "Enviado";
        }

        async function checkFriendRequests() {
            const reqs = await api(`/api/friend-requests/${currentUser.username}`);
            if(reqs && reqs.length > 0) {
                document.getElementById('friend-requests-bar').classList.remove('hidden');
                document.getElementById('req-count').innerText = reqs.length;
                const list = document.getElementById('requests-list');
                list.innerHTML = '';
                reqs.forEach(r => {
                    list.innerHTML += `
                        <div class="flex justify-between items-center bg-[#2C2C2E] p-3 rounded mb-2">
                            <span class="text-white font-bold">${r.username}</span>
                            <div class="flex gap-2">
                                <button onclick="respond('${r.username}', 'accept')" class="text-[#FF3B30] font-bold">Aceitar</button>
                                <button onclick="respond('${r.username}', 'reject')" class="text-gray-500">X</button>
                            </div>
                        </div>`;
                });
            }
        }

        async function respond(friend, action) {
            await api('/api/respond-request', 'POST', { me: currentUser.username, friend, action });
            location.reload();
        }

        // --- PROFILE ---
        function updateMyProfileUI() {
            const pic = currentUser.avatar || `https://ui-avatars.com/api/?name=${currentUser.username}`;
            document.getElementById('settings_avatar').src = pic;
            document.getElementById('my_status_pic').src = pic;
            document.getElementById('settings_name').innerText = currentUser.username;
            document.getElementById('settings_bio').value = currentUser.bio || '';
        }

        async function updateProfilePic(e) {
            const f = e.target.files[0];
            const r = new FileReader();
            r.onload = async () => {
                currentUser.avatar = r.result;
                await api('/api/update-profile', 'POST', currentUser);
                updateMyProfileUI();
                localStorage.setItem('whats_black_user', JSON.stringify(currentUser));
            }; r.readAsDataURL(f);
        }

        function switchTab(t) {
            ['chats','status','settings'].forEach(x => {
                document.getElementById('tab-'+x).classList.add('screen-hidden');
                document.getElementById('tab-'+x).classList.remove('screen-active');
                document.getElementById('btn-'+x).classList.remove('active');
            });
            document.getElementById('tab-'+t).classList.remove('screen-hidden');
            document.getElementById('tab-'+t).classList.add('screen-active');
            document.getElementById('btn-'+t).classList.add('active');
            if(t === 'status') loadStatus();
            if(t === 'chats') loadChatList();
        }

        function openModal(id){ document.getElementById(id).classList.remove('hidden'); }
        function closeModal(id){ document.getElementById(id).classList.add('hidden'); }
        function formatTime(d) { if(!d) return ''; return new Date(d).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}); }
        async function openContactInfo() {
            if(!activeChat) return;
            const u = await api(`/api/user/${activeChat}`);
            document.getElementById('contact-info-modal').classList.remove('hidden');
            document.getElementById('info_avatar').src = u.avatar || `https://ui-avatars.com/api/?name=${u.username}`;
            document.getElementById('info_name').innerText = u.username;
            document.getElementById('info_bio').innerText = u.bio || "Sem recado";
            const last = u.last_seen ? new Date(u.last_seen).toLocaleTimeString() : '--';
            document.getElementById('info_seen').innerText = `Visto às ${last}`;
        }
    </script>
</body>
</html>
