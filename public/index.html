<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RED PROTOCOL</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Inter:wght@300;400;600&display=swap');
        body { font-family: 'Inter', sans-serif; background: #000; color: #fff; margin: 0; }
        .gamer-font { font-family: 'Orbitron', sans-serif; }
        .red-ui { background: rgba(15, 15, 15, 0.95); border: 1px solid rgba(255, 0, 0, 0.2); }
        .msg-me { background: #7f1d1d; border-radius: 15px 15px 2px 15px; align-self: flex-end; }
        .msg-them { background: #1a1a1a; border-radius: 15px 15px 15px 2px; align-self: flex-start; border: 1px solid #333; }
        .hidden { display: none; }
    </style>
</head>
<body class="h-screen flex flex-col">

    <div id="auth-screen" class="fixed inset-0 z-[200] bg-black flex items-center justify-center p-6">
        <div class="red-ui p-8 w-full max-w-sm rounded-2xl shadow-[0_0_30px_rgba(255,0,0,0.1)]">
            <h1 class="gamer-font text-red-600 text-3xl font-black mb-8 italic uppercase text-center">Red<span class="text-white">ID</span></h1>
            <input id="u" placeholder="USU√ÅRIO" class="w-full bg-zinc-900 p-4 mb-3 rounded-xl border border-zinc-800 focus:border-red-600 outline-none">
            <input id="p" type="password" placeholder="SENHA" class="w-full bg-zinc-900 p-4 mb-8 rounded-xl border border-zinc-800 focus:border-red-600 outline-none">
            <button onclick="handleAuth('login')" class="w-full bg-red-600 py-4 rounded-xl font-bold uppercase hover:bg-red-700 transition">Entrar</button>
            <button onclick="handleAuth('register')" class="w-full mt-4 text-zinc-500 text-[10px] font-bold uppercase text-center">Registrar Protocolo</button>
        </div>
    </div>

    <div id="app" class="hidden flex flex-col h-full">
        <header class="h-16 flex items-center justify-between px-6 border-b border-red-900/30 bg-zinc-900">
            <h2 id="title" class="gamer-font font-bold text-red-600 text-sm uppercase">Mensagens</h2>
            <div class="flex gap-4">
                <button onclick="tab('status')">‚≠ï</button>
                <button onclick="tab('profile')">üë§</button>
            </div>
        </header>

        <main id="main-view" class="flex-1 overflow-y-auto">
            <div id="chats-view" class="p-4 space-y-2">
                <p class="text-zinc-600 text-[10px] text-center mt-20">BUSQUE UM USU√ÅRIO PARA COME√áAR</p>
            </div>

            <div id="status-view" class="hidden p-4 space-y-6">
                <button onclick="document.getElementById('st-file').click()" class="w-full bg-zinc-900 border border-red-600/30 p-6 rounded-2xl font-bold uppercase text-xs">+ Postar Status (Foto/V√≠deo)</button>
                <input type="file" id="st-file" class="hidden" onchange="postStatus(event)">
                <div id="st-list" class="grid grid-cols-2 gap-4"></div>
            </div>

            <div id="profile-view" class="hidden p-8 flex flex-col items-center">
                <img id="my-img" class="w-32 h-32 rounded-full border-4 border-red-600 object-cover bg-zinc-800">
                <input type="file" id="up-img" class="hidden" onchange="previewAvatar(event)">
                <button onclick="document.getElementById('up-img').click()" class="mt-2 text-[10px] text-red-500 underline">TROCAR FOTO</button>
                <input id="my-bio" class="mt-8 w-full bg-zinc-900 p-4 rounded-xl border border-zinc-800 text-center" placeholder="Bio...">
                <button onclick="saveProfile()" class="mt-4 bg-red-600 px-10 py-3 rounded-full font-bold text-xs uppercase">Salvar</button>
                <button onclick="logout()" class="mt-20 text-zinc-700 text-[10px]">SAIR DA CONTA</button>
            </div>
        </main>

        <div id="chat-win" class="fixed inset-0 bg-black z-[150] hidden flex flex-col">
            <header class="h-16 bg-zinc-900 flex items-center px-4 gap-4 border-b border-red-600">
                <button onclick="closeChat()" class="text-red-600 text-xl font-bold">‚Üê</button>
                <img id="t-img" class="w-10 h-10 rounded-full bg-zinc-800 object-cover">
                <div>
                    <h4 id="t-name" class="text-sm font-bold">User</h4>
                    <span id="t-status" class="text-[8px] text-zinc-500 uppercase italic">Offline</span>
                </div>
            </header>
            <div id="msgs-box" class="flex-1 overflow-y-auto p-4 flex flex-col gap-3"></div>
            <div class="p-4 bg-zinc-900 flex gap-2 items-center">
                <button onmousedown="startVoice()" onmouseup="stopVoice()" class="w-12 h-12 bg-zinc-800 rounded-full flex items-center justify-center text-xl">üé§</button>
                <input id="m-input" class="flex-1 bg-black p-4 rounded-2xl border border-zinc-800 outline-none text-sm" placeholder="Escreva...">
                <button onclick="sendMessage()" class="bg-red-600 w-12 h-12 rounded-full font-bold">‚ûî</button>
            </div>
        </div>

        <button onclick="searchUser()" class="fixed bottom-8 right-8 w-16 h-16 bg-red-600 rounded-full shadow-lg shadow-red-600/40 text-3xl font-bold">+</button>
    </div>

    <script>
        const socket = io();
        let me = null, target = null, recorder, chunks = [];

        window.onload = () => {
            const saved = localStorage.getItem('red_u');
            if(saved) { me = JSON.parse(saved); loginSuccess(); }
        };

        async function handleAuth(type) {
            const u = document.getElementById('u').value, p = document.getElementById('p').value;
            const res = await fetch(`/${type}`, {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({username: u, password: p})
            });
            const data = await res.json();
            if(res.ok) {
                if(type === 'login') {
                    me = data; localStorage.setItem('red_u', JSON.stringify(me));
                    loginSuccess();
                } else alert("REGISTRADO!");
            } else alert("Erro!");
        }

        function loginSuccess() {
            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('app').classList.remove('hidden');
            socket.emit('join', me.username);
            document.getElementById('my-img').src = me.avatar || 'https://ui-avatars.com/api/?name='+me.username;
            document.getElementById('my-bio').value = me.bio;
        }

        function tab(t) {
            ['chats', 'status', 'profile'].forEach(id => document.getElementById(id+'-view').classList.add('hidden'));
            document.getElementById(t+'-view').classList.remove('hidden');
            if(t === 'status') loadStatus();
        }

        async function searchUser() {
            const u = prompt("USERNAME:");
            if(!u) return;
            const res = await fetch(`/user/${u}`).then(r => r.json());
            if(res.error) return alert("N√ÉO ENCONTRADO");
            openChat(res);
        }

        async function openChat(user) {
            target = user;
            document.getElementById('chat-win').classList.remove('hidden');
            document.getElementById('t-name').innerText = target.username;
            document.getElementById('t-img').src = target.avatar || 'https://ui-avatars.com/api/?name='+target.username;
            
            const msgs = await fetch(`/messages/${me.username}/${target.username}`).then(r => r.json());
            document.getElementById('msgs-box').innerHTML = '';
            msgs.forEach(m => appendMsg(m));
        }

        function sendMessage(type = 'text', content = null) {
            const c = content || document.getElementById('m-input').value;
            if(!c || !target) return;
            const msg = { s: me.username, r: target.username, c, type, time: new Date() };
            socket.emit('chat_message', msg);
            appendMsg(msg);
            document.getElementById('m-input').value = '';
        }

        socket.on('new_message', (d) => {
            if(target && d.s === target.username) appendMsg(d);
            else alert("Nova mensagem de: " + d.s);
        });

        function appendMsg(d) {
            const isMe = d.s === me.username;
            const div = document.createElement('div');
            div.className = isMe ? 'msg-me p-3 text-sm max-w-[80%]' : 'msg-them p-3 text-sm max-w-[80%]';
            if(d.type === 'voice') div.innerHTML = `<audio src="${d.c}" controls class="w-48"></audio>`;
            else div.innerText = d.c;
            document.getElementById('msgs-box').appendChild(div);
            document.getElementById('msgs-box').scrollTop = 99999;
        }

        // VOZ
        async function startVoice() {
            chunks = [];
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            recorder = new MediaRecorder(stream);
            recorder.ondataavailable = e => chunks.push(e.data);
            recorder.onstop = () => {
                const reader = new FileReader();
                reader.readAsDataURL(new Blob(chunks));
                reader.onloadend = () => sendMessage('voice', reader.result);
            };
            recorder.start();
        }
        function stopVoice() { recorder.stop(); }

        // PERFIL E STATUS (Simplificado)
        function previewAvatar(e) {
            const reader = new FileReader();
            reader.readAsDataURL(e.target.files[0]);
            reader.onload = () => document.getElementById('my-img').src = reader.result;
        }

        async function saveProfile() {
            await fetch('/update-profile', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({username: me.username, avatar: document.getElementById('my-img').src, bio: document.getElementById('my-bio').value})
            });
            alert("SALVO!");
        }

        async function postStatus(e) {
            const reader = new FileReader();
            reader.readAsDataURL(e.target.files[0]);
            reader.onload = async () => {
                await fetch('/post-status', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({username: me.username, type: 'image', content: reader.result})
                });
                loadStatus();
            };
        }

        async function loadStatus() {
            const res = await fetch('/get-status').then(r => r.json());
            document.getElementById('st-list').innerHTML = res.map(s => `<img src="${s.content}" class="w-full aspect-square object-cover rounded-xl border border-red-900">`).join('');
        }

        function closeChat() { document.getElementById('chat-win').classList.add('hidden'); target = null; }
        function logout() { localStorage.clear(); location.reload(); }
    </script>
</body>
</html>
