<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Chat iOS Dark Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        /* --- CONFIGURA√á√ïES DARK MODE & THEME --- */
        :root {
            --bg-app: #000000;
            --bg-secondary: #1C1C1E;
            --bg-header: #161616;
            --text-primary: #FFFFFF;
            --text-secondary: #8E8E93;
            --separator: #2C2C2E;
            --accent-color: #0A84FF;
            --bubble-me: #FF3B30; /* Vermelho iOS Pro */
            --bubble-them: #2C2C2E; /* Cinza Escuro iOS */
            --chat-bg-color: #0B141A;
        }

        body, html { 
            height: 100%; width: 100%; overflow: hidden; 
            background: var(--bg-app); 
            color: var(--text-primary);
            font-family: -apple-system, BlinkMacSystemFont, sans-serif; 
            -webkit-tap-highlight-color: transparent; 
        }
        
        /* LAYOUT & Z-INDEX */
        #login-screen { z-index: 9999; background-color: var(--bg-app); }
        #main-app { z-index: 10; position: absolute; inset: 0; display: flex; flex-direction: column; background-color: var(--bg-app); }
        
        /* TELA DE CHAT (SLIDE OVER) */
        #chat-room { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background-color: var(--chat-bg-color);
            background-image: linear-gradient(rgba(0,0,0,0.85), rgba(0,0,0,0.85)), url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png');
            background-blend-mode: overlay;
            z-index: 100;
            transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.25, 1, 0.5, 1);
            display: flex; flex-direction: column;
        }
        .chat-open { transform: translateX(0) !important; }
        
        /* BAL√ïES DE MENSAGEM */
        .msg-bubble { 
            max-width: 85%; padding: 6px 10px; font-size: 16px; 
            margin-bottom: 2px; position: relative; 
            color: #E9EDEF; word-wrap: break-word;
            box-shadow: 0 1px 0.5px rgba(0,0,0,0.13);
        }
        .msg-me { 
            background: var(--bubble-me); align-self: flex-end; 
            border-radius: 12px 12px 0px 12px; margin-right: 12px; 
        }
        .msg-me::after {
            content: ""; position: absolute; right: -8px; top: 0;
            width: 12px; height: 12px; background: var(--bubble-me);
            clip-path: polygon(0 0, 0 100%, 100% 0);
        }
        .msg-them { 
            background: var(--bubble-them); align-self: flex-start; 
            border-radius: 12px 12px 12px 0px; margin-left: 12px; 
        }
        .msg-them::after {
            content: ""; position: absolute; left: -8px; top: 0;
            width: 12px; height: 12px; background: var(--bubble-them);
            clip-path: polygon(100% 0, 100% 100%, 0 0);
        }
        .msg-media { padding: 3px !important; }
        .msg-media img, .msg-media video { border-radius: 5px; display: block; width: 100%; }
        
        /* STATUS VIEWER */
        #story-viewer {
            position: fixed; inset: 0; z-index: 200; background: black;
            display: flex; flex-direction: column;
            transform: scale(0.9); opacity: 0; pointer-events: none;
            transition: all 0.2s ease-out;
        }
        #story-viewer.active { transform: scale(1); opacity: 1; pointer-events: all; }
        
        .story-progress-container {
            display: flex; gap: 4px; padding: 10px 4px; 
            position: absolute; top: 0; left: 0; right: 0; z-index: 50;
        }
        .story-progress-bar {
            height: 2px; flex: 1; background: rgba(255,255,255,0.3); border-radius: 2px; overflow: hidden;
        }
        .story-progress-fill {
            height: 100%; background: white; width: 0%; transition: width 0.1s linear;
        }
        .story-footer {
            position: absolute; bottom: 0; left: 0; right: 0;
            padding: 20px; background: linear-gradient(transparent, rgba(0,0,0,0.8));
            display: flex; align-items: center; gap: 15px; z-index: 100;
        }
        .story-input {
            flex: 1; background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3);
            border-radius: 25px; padding: 10px 20px; color: white; outline: none;
        }
        .story-like-btn { font-size: 24px; cursor: pointer; transition: transform 0.2s; }
        .story-like-btn.liked { color: #FF3B30; transform: scale(1.2); }
        
        .story-media {
            width: 100%; height: 100%; object-fit: contain; display: block;
        }

        /* STATUS CREATOR */
        #status-creator {
            position: fixed; inset: 0; z-index: 150; background: #000;
            display: flex; flex-direction: column; height: 100%;
            transform: translateY(100%); transition: transform 0.3s;
        }
        #status-creator.open { transform: translateY(0); }
        
        .creator-footer {
            flex-shrink: 0; background: #1C1C1E; width: 100%; padding-bottom: env(safe-area-inset-bottom);
        }

        /* STATUS RING */
        .status-ring { padding: 2px; border-radius: 50%; border: 2px solid #FF3B30; }
        .status-ring-viewed { border-color: #545458; }

        /* UTILIT√ÅRIOS */
        .safe-pb { padding-bottom: env(safe-area-inset-bottom); }
        .pt-safe { padding-top: env(safe-area-inset-top); }
        .active-tab svg { color: #FF3B30; }
        .active-tab span { color: #FF3B30; }
        .input-dark { background-color: #2C2C2E; color: white; border: none; }
        .input-dark::placeholder { color: #8E8E93; }
        
        .tick-icon { font-size: 14px; margin-right: 4px; font-weight: normal; letter-spacing: -1px; }
        .tick-read { color: #34B7F1; }
        .tick-sent { color: #8E8E93; }
        
        /* LOADING SPINNER */
        .spinner {
            border: 2px solid rgba(255,255,255,0.1);
            border-top: 2px solid #FF3B30;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>

    <div id="login-screen" class="fixed inset-0 flex flex-col items-center justify-center p-8">
        <h1 class="text-3xl font-bold mb-8 text-[#FF3B30]">WhatsApp Pro</h1>
        <input id="u_auth" placeholder="Usu√°rio" class="w-full input-dark p-4 rounded-xl mb-3 outline-none focus:ring-1 focus:ring-red-500" autocomplete="username">
        <input id="p_auth" type="password" placeholder="Senha" class="w-full input-dark p-4 rounded-xl mb-6 outline-none focus:ring-1 focus:ring-red-500" autocomplete="current-password">
        <button onclick="auth('login')" class="w-full bg-[#FF3B30] active:bg-red-700 text-white py-4 rounded-xl font-bold transition">Entrar</button>
        <button onclick="auth('register')" class="mt-4 text-[#FF3B30] font-medium">Criar Conta</button>
        <div id="auth-loading" class="hidden mt-4"><div class="spinner"></div></div>
    </div>

    <div id="main-app" class="hidden">
        
        <header class="bg-[#161616] border-b border-[#2C2C2E] pt-safe pb-3 px-4 flex justify-between items-center shrink-0 min-h-[60px]">
            <button class="text-[#FF3B30] text-[17px]">Editar</button>
            <h1 id="header-title" class="font-bold text-[18px] text-white">Conversas</h1>
            <button onclick="document.getElementById('new-chat-modal').classList.remove('hidden')" class="text-[#FF3B30]">
                <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
            </button>
        </header>

        <div class="flex-1 overflow-y-auto relative">
            
            <div id="tab-chats" class="w-full">
                <div class="px-4 py-2 bg-[#161616]">
                    <input placeholder="Pesquisar" class="w-full bg-[#2C2C2E] text-white rounded-lg px-3 py-1.5 text-center outline-none placeholder-gray-500 focus:text-left focus:pl-3 transition-all">
                </div>
                <div id="chat-list" class="border-t border-[#2C2C2E]"></div>
            </div>

            <div id="tab-status" class="hidden w-full min-h-full pb-20">
                <h1 class="text-3xl font-bold px-4 py-4 text-white">Status</h1>
                
                <div class="bg-[#1C1C1E] px-4 py-3 flex items-center gap-3 border-y border-[#2C2C2E] relative">
                     <div class="relative">
                        <img id="my_status_pic" class="w-14 h-14 rounded-full bg-gray-700 object-cover">
                        <button onclick="openStatusCreator()" class="absolute bottom-0 right-0 bg-[#0A84FF] rounded-full p-1 border-2 border-[#1C1C1E] text-white">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" stroke-width="3" viewBox="0 0 24 24"><path d="M12 4v16m8-8H4"/></svg>
                        </button>
                     </div>
                     <div class="flex-1 cursor-pointer" onclick="checkMyStatus()">
                         <h3 class="font-bold text-white">Meu Status</h3>
                         <p class="text-gray-400 text-sm">Toque para ver, + para adicionar</p>
                     </div>
                     <div class="flex gap-4 text-[#0A84FF]">
                        <button onclick="openStatusCreator('text')" class="bg-[#2C2C2E] p-2 rounded-full"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/></svg></button>
                        <button onclick="openStatusCreator('media')" class="bg-[#2C2C2E] p-2 rounded-full"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/></svg></button>
                     </div>
                </div>
                
                <h4 class="text-gray-500 text-xs font-bold px-4 mt-6 mb-2 uppercase">Atualiza√ß√µes Recentes</h4>
                <div id="status-list" class="bg-[#1C1C1E] pl-4 border-t border-b border-[#2C2C2E]"></div>
            </div>

            <div id="tab-settings" class="hidden w-full min-h-full pb-20">
                <h1 class="text-3xl font-bold px-4 py-4 text-white">Ajustes</h1>
                <div class="bg-[#1C1C1E] border-y border-[#2C2C2E] flex items-center p-4 gap-4 mb-8 cursor-pointer" onclick="document.getElementById('avatar_file').click()">
                    <img id="settings_avatar" class="w-16 h-16 rounded-full bg-gray-700 object-cover">
                    <div class="flex-1">
                        <h2 id="settings_name" class="text-xl font-semibold text-white">User</h2>
                        <p class="text-gray-400 text-sm">Toque para mudar foto</p>
                    </div>
                    <input type="file" id="avatar_file" hidden accept="image/*" onchange="updateProfilePic(event)">
                </div>
                <div class="bg-[#1C1C1E] border-y border-[#2C2C2E] p-4 mb-8">
                    <label class="text-xs text-gray-500 uppercase">Recado</label>
                    <input id="settings_bio" class="w-full mt-1 text-[17px] bg-transparent text-white outline-none" onblur="saveBio(this.value)">
                </div>
                <button onclick="logout()" class="w-full bg-[#1C1C1E] p-4 text-[#FF3B30] text-lg border-y border-[#2C2C2E] text-left">Sair</button>
            </div>
        </div>

        <nav class="bg-[#161616]/95 backdrop-blur border-t border-[#2C2C2E] h-[83px] flex justify-around pt-2 pb-safe shrink-0 z-50">
            <button onclick="switchTab('status')" id="btn-status" class="flex flex-col items-center gap-1 w-16 text-[#8E8E93]">
                <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                <span class="text-[10px]">Status</span>
            </button>
            <button onclick="switchTab('chats')" id="btn-chats" class="flex flex-col items-center gap-1 w-16 text-[#8E8E93] active-tab">
                <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>
                <span class="text-[10px]">Conversas</span>
            </button>
            <button onclick="switchTab('settings')" id="btn-settings" class="flex flex-col items-center gap-1 w-16 text-[#8E8E93]">
                <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                <span class="text-[10px]">Ajustes</span>
            </button>
        </nav>
    </div>

    <div id="chat-room">
        <header class="h-16 bg-[#161616]/95 backdrop-blur border-b border-[#2C2C2E] flex items-center px-2 shrink-0 z-50 shadow-sm pt-safe">
            <button onclick="closeChat()" class="flex items-center text-[#FF3B30] pr-2 h-full">
                <svg class="w-8 h-8" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M15 19l-7-7 7-7"/></svg>
                <span class="text-[17px] -ml-1">Voltar</span>
            </button>
            <div class="flex-1 flex items-center gap-3 cursor-pointer py-1" onclick="document.getElementById('contact-modal').classList.remove('hidden')">
                <img id="chat_avatar" class="w-9 h-9 rounded-full bg-gray-700 object-cover border border-[#2C2C2E]">
                <div class="flex flex-col justify-center">
                    <h3 id="chat_name" class="font-semibold text-[16px] leading-tight text-white">--</h3>
                    <span id="chat_status" class="text-[11px] text-gray-400 leading-tight">Toque para dados</span>
                </div>
            </div>
        </header>

        <div id="msg-container" class="flex-1 overflow-y-auto p-4 flex flex-col pb-4"></div>

        <div class="bg-[#161616] border-t border-[#2C2C2E] px-2 py-2 flex items-end gap-2 pb-safe shrink-0">
            <button onclick="document.getElementById('media_input').click()" class="text-[#FF3B30] p-2 mb-1">
                <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 4v16m8-8H4"/></svg>
            </button>
            <input type="file" id="media_input" hidden accept="image/*,video/*" onchange="sendMedia(event)">
            <div class="flex-1 bg-[#2C2C2E] border border-[#3A3A3C] rounded-2xl min-h-[36px] flex items-center px-3 py-1 mb-1">
                <input id="chat-input" class="w-full bg-transparent outline-none text-[16px] text-white max-h-24" placeholder="Mensagem" onkeydown="handleKey(event)" oninput="toggleSendBtn()">
            </div>
            <button onclick="sendText()" id="send-btn" class="text-[#FF3B30] font-bold p-2 mb-1 hidden">Enviar</button>
            <button onclick="toggleMic()" id="mic-btn" class="text-[#FF3B30] p-2 mb-1"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"/></svg></button>
        </div>
    </div>

    <div id="story-viewer">
        <div class="story-progress-container" id="story-bars"></div>
        
        <div class="flex items-center gap-3 p-4 z-20 mt-4 absolute top-0 left-0 right-0 pt-safe">
            <button onclick="closeStory()" class="text-white"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg></button>
            <img id="sv-avatar" class="w-10 h-10 rounded-full border border-white/20 bg-gray-700">
            <div>
                <h3 id="sv-username" class="font-bold text-white text-sm shadow-black drop-shadow-md">User</h3>
                <span id="sv-time" class="text-xs text-white/80">H√° 20 min</span>
            </div>
        </div>

        <div id="sv-content" class="absolute inset-0 flex items-center justify-center bg-black"></div>
        
        <div id="sv-caption-container" class="absolute bottom-24 left-0 right-0 p-4 text-center z-20 pointer-events-none">
             <p id="sv-caption" class="text-white bg-black/50 p-2 rounded-lg inline-block text-lg pointer-events-auto"></p>
        </div>

        <div class="absolute inset-0 flex z-10">
            <div class="w-1/4 h-full" onclick="prevStory()"></div>
            <div class="w-2/4 h-full" onclick="nextStory()"></div>
            <div class="w-1/4 h-full" onclick="nextStory()"></div>
        </div>

        <div class="story-footer">
            <input type="text" id="story-reply-input" placeholder="Responder..." class="story-input" onclick="event.stopPropagation()">
            <div id="story-like-btn" onclick="likeStory(event)" class="story-like-btn">‚ù§Ô∏è</div>
        </div>

        <div id="sv-footer" class="absolute bottom-24 w-full p-4 pb-safe bg-black/40 backdrop-blur z-30 hidden flex justify-center">
            <button onclick="showViewers()" class="flex flex-col items-center text-white pointer-events-auto">
                <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>
                <span class="text-xs" id="sv-view-count">0 views</span>
            </button>
        </div>
    </div>

    <div id="viewers-modal" class="fixed inset-0 z-[250] hidden bg-black/80 backdrop-blur-sm" onclick="this.classList.add('hidden')">
        <div class="absolute inset-x-0 bottom-0 bg-[#1C1C1E] rounded-t-2xl max-h-[60%] overflow-y-auto p-4 pb-safe" onclick="event.stopPropagation()">
            <h3 class="text-white font-bold text-lg mb-4 text-center">Visualizado por</h3>
            <div id="viewers-list" class="space-y-3"></div>
        </div>
    </div>

    <div id="status-creator">
        <div class="flex justify-between items-center p-4 pt-safe shrink-0">
            <button onclick="closeStatusCreator()" class="text-white text-lg">Cancelar</button>
            <button onclick="submitStatus()" class="text-[#0A84FF] font-bold text-lg">Enviar</button>
        </div>
        
        <div class="flex-1 relative flex flex-col justify-center items-center overflow-hidden min-h-0" id="st-preview-area">
            <textarea id="st-text-input" class="hidden w-full h-full bg-transparent text-white text-4xl text-center p-8 outline-none resize-none flex items-center justify-center font-bold" placeholder="Digite seu status..."></textarea>
            <img id="st-img-preview" class="hidden max-h-full max-w-full object-contain">
            <video id="st-video-preview" class="hidden max-h-full max-w-full object-contain" controls></video>
        </div>

        <div class="creator-footer p-4 bg-[#1C1C1E] w-full shrink-0">
            <input id="st-caption" class="w-full bg-[#2C2C2E] text-white p-3 rounded-xl mb-4" placeholder="Adicione uma legenda...">
            
            <div id="st-controls-text" class="hidden flex justify-center gap-4 mb-4">
                <div onclick="setBg('#ff0055')" class="w-8 h-8 rounded-full bg-[#ff0055] border-2 border-white cursor-pointer"></div>
                <div onclick="setBg('#0099ff')" class="w-8 h-8 rounded-full bg-[#0099ff] border-2 border-white cursor-pointer"></div>
                <div onclick="setBg('#6600cc')" class="w-8 h-8 rounded-full bg-[#6600cc] border-2 border-white cursor-pointer"></div>
                <div onclick="setBg('#00cc66')" class="w-8 h-8 rounded-full bg-[#00cc66] border-2 border-white cursor-pointer"></div>
                <div onclick="setBg('#ff9900')" class="w-8 h-8 rounded-full bg-[#ff9900] border-2 border-white cursor-pointer"></div>
            </div>
            
            <input type="file" id="st-file-input" hidden accept="image/*,video/*" onchange="handleStatusFile(event)">
        </div>
    </div>

    <div id="new-chat-modal" class="fixed inset-0 z-[200] hidden bg-black/70 backdrop-blur-sm">
        <div class="absolute inset-x-0 bottom-0 bg-[#1C1C1E] rounded-t-2xl p-4 pb-10 border-t border-[#3A3A3C]">
            <div class="flex justify-between mb-4">
                <button onclick="document.getElementById('new-chat-modal').classList.add('hidden')" class="text-[#FF3B30] font-bold">Cancelar</button>
                <span class="font-bold text-white">Nova Conversa</span>
                <span class="w-10"></span>
            </div>
            <input id="new-chat-input" placeholder="Usu√°rio exato..." class="w-full p-3 rounded-lg border border-[#3A3A3C] bg-[#2C2C2E] text-white outline-none">
            <button onclick="startChat()" class="w-full bg-[#FF3B30] active:bg-red-700 text-white font-bold py-3 mt-4 rounded-lg transition">Iniciar</button>
        </div>
    </div>

    <div id="contact-modal" class="fixed inset-0 z-[200] hidden bg-black/70 backdrop-blur-sm" onclick="this.classList.add('hidden')">
        <div class="absolute inset-x-0 bottom-0 bg-[#1C1C1E] rounded-t-2xl h-[70%] p-6 flex flex-col items-center border-t border-[#3A3A3C]" onclick="event.stopPropagation()">
            <img id="info_avatar" class="w-32 h-32 rounded-full bg-gray-700 object-cover mb-4 shadow-lg border-2 border-[#2C2C2E]">
            <h2 id="info_name" class="text-2xl font-bold mb-1 text-white">Nome</h2>
            <p id="info_bio" class="text-gray-400 text-center bg-[#2C2C2E] p-4 rounded-xl w-full shadow-sm">Sem recado.</p>
        </div>
    </div>

    <script>
        const socket = io();
        let me = null, active = null;
        let currentStories = [], currentStoryIndex = 0, storyTimer = null;
        let statusCreatorMode = null, statusCreatorBgColor = '#0099ff';

        // --- √çCONE DE VERIFICADO ---
        function getVerifiedIcon(isVerified) {
            if (!isVerified) return '';
            return `
            <svg class="w-4 h-4 ml-1 inline-block text-[#1D9BF0]" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12.0001 2C12.4401 2 12.8701 2.13 13.2401 2.38L14.7301 3.33C15.0201 3.52 15.3501 3.63 15.7001 3.63C15.7901 3.63 15.8901 3.62 15.9801 3.61L17.7401 3.44C18.6801 3.35 19.5701 3.96 19.8201 4.88L20.2901 6.59C20.3801 6.93 20.5801 7.23 20.8501 7.44L22.2801 8.52C23.0301 9.09 23.2701 10.1 22.8401 10.94L22.0401 12.53C21.8901 12.83 21.8901 13.18 22.0401 13.48L22.8401 15.07C23.2701 15.91 23.0301 16.92 22.2801 17.49L20.8501 18.57C20.5801 18.78 20.3801 19.08 20.2901 19.42L19.8201 21.13C19.5701 22.05 18.6801 22.66 17.7401 22.57L15.9801 22.4C15.8901 22.39 15.7901 22.38 15.7001 22.38C15.3501 22.38 15.0101 22.49 14.7301 22.68L13.2401 23.63C12.4901 24.11 11.5101 24.11 10.7601 23.63L9.27006 22.68C8.98006 22.49 8.65006 22.38 8.30006 22.38C8.21006 22.38 8.11006 22.39 8.02006 22.4L6.26006 22.57C5.32006 22.66 4.43006 22.05 4.18006 21.13L3.71006 19.42C3.62006 19.08 3.42006 18.78 3.15006 18.57L1.72006 17.49C0.97006 16.92 0.73006 15.91 1.16006 15.07L1.96006 13.48C2.11006 13.18 2.11006 12.83 1.96006 12.53L1.16006 10.94C0.73006 10.1 0.97006 9.09 1.72006 8.52L3.15006 7.44C3.42006 7.23 3.62006 6.93 3.71006 6.59L4.18006 4.88C4.43006 3.96 5.32006 3.35 6.26006 3.44L8.02006 3.61C8.11006 3.62 8.21006 3.63 8.30006 3.63C8.65006 3.63 8.98006 3.52 9.27006 3.33L10.7601 2.38C11.1301 2.13 11.5601 2 12.0001 2ZM10.5901 16.17L17.6601 9.1L16.2401 7.68L10.5901 13.34L7.76006 10.51L6.34006 11.92L10.5901 16.17Z" />
            </svg>`;
        }

        // --- SISTEMA DE LOGIN ---
        window.onload = () => {
            const s = localStorage.getItem('whats_v4');
            if(s) { 
                try {
                    me = JSON.parse(s); 
                    enter(); 
                } catch(e) {
                    console.error("Erro ao carregar sess√£o:", e);
                    localStorage.removeItem('whats_v4');
                }
            }
        };

        async function auth(endpoint) {
            const u = document.getElementById('u_auth').value.trim();
            const p = document.getElementById('p_auth').value.trim();
            
            if(!u || !p) return alert("Preencha usu√°rio e senha");
            
            const loading = document.getElementById('auth-loading');
            loading.classList.remove('hidden');
            
            try {
                const res = await fetch('/' + endpoint, {
                    method:'POST',
                    headers:{'Content-Type':'application/json'},
                    body:JSON.stringify({username:u, password:p})
                });
                
                const data = await res.json();
                
                if(res.ok) {
                    if(endpoint === 'login'){
                        me = data; 
                        localStorage.setItem('whats_v4', JSON.stringify(me)); 
                        enter();
                    } else {
                        alert("‚úÖ Usu√°rio criado! Agora fa√ßa login.");
                        document.getElementById('p_auth').value = '';
                    }
                } else {
                    alert("‚ùå " + (data.error || "Erro na autentica√ß√£o"));
                }
            } catch(e) {
                console.error("Erro de conex√£o:", e);
                alert("‚ùå Erro de conex√£o com o servidor");
            } finally {
                loading.classList.add('hidden');
            }
        }

        function enter() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            socket.emit('join', me.username);
            updateMeUI(); 
            loadChats();
            loadStatus();
        }

        function logout() { 
            localStorage.removeItem('whats_v4'); 
            location.reload(); 
        }

        // --- FUN√á√ïES DE UI ---
        function updateMeUI() {
            const avatar = me.avatar || `https://ui-avatars.com/api/?name=${me.username}`;
            document.getElementById('settings_avatar').src = avatar;
            document.getElementById('my_status_pic').src = avatar;
            document.getElementById('settings_name').innerText = me.username;
            document.getElementById('settings_bio').value = me.bio || '';
        }

        function switchTab(tab) {
            document.querySelectorAll('[id^="tab-"]').forEach(t => t.classList.add('hidden'));
            document.querySelectorAll('[id^="btn-"]').forEach(b => b.classList.remove('active-tab'));
            
            document.getElementById('tab-' + tab).classList.remove('hidden');
            document.getElementById('btn-' + tab).classList.add('active-tab');
            
            const titles = { chats: 'Conversas', status: 'Status', settings: 'Ajustes' };
            document.getElementById('header-title').innerText = titles[tab] || 'App';
            
            if(tab === 'status') loadStatus();
        }

        // --- FUN√á√ïES DE CHAT ---
        async function loadChats() {
            try {
                const d = await fetch('/chats/'+me.username).then(r=>r.json());
                const listEl = document.getElementById('chat-list');
                
                if(d.length === 0) {
                    listEl.innerHTML = '<p class="text-gray-500 text-center py-8">Nenhuma conversa ainda</p>';
                    return;
                }
                          listEl.innerHTML = d.map(c => {
                    const avatar = c.avatar || `https://ui-avatars.com/api/?name=${c.contact}`;
                    const time = c.last_time ? new Date(c.last_time).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}) : '';
                    let statusIcon = '';
                    if(c.last_s === me.username) {
                        if(c.last_status === 2) statusIcon = '<span class="tick-icon tick-read">‚úì‚úì</span>';
                        else if(c.last_status === 1) statusIcon = '<span class="tick-icon tick-sent">‚úì‚úì</span>';
                        else statusIcon = '<span class="tick-icon tick-sent">‚úì</span>';
                    }

                    return `
                    <div onclick="openChat('${c.contact}')" class="flex items-center gap-3 py-3 pl-4 pr-4 border-b border-[#2C2C2E] cursor-pointer bg-[#161616] active:bg-[#2C2C2E]">
                        <div class="relative shrink-0">
                            <img src="${avatar}" class="w-14 h-14 rounded-full bg-gray-700 object-cover">
                            ${c.is_online ? '<div class="absolute bottom-0 right-0 w-3.5 h-3.5 bg-green-500 rounded-full border-2 border-[#161616]"></div>' : ''}
                        </div>
                        <div class="flex-1 min-w-0 flex flex-col justify-center h-14">
                            <div class="flex justify-between items-baseline">
                                <h3 class="font-bold text-[17px] text-white truncate flex items-center">
                                    ${c.contact} ${getVerifiedIcon(c.is_verified)}
                                </h3>
                                <span class="text-[13px] ${c.unread > 0 ? 'text-[#FF3B30]' : 'text-gray-500'} shrink-0 font-medium">${time}</span>
                            </div>
                            <div class="flex justify-between items-center mt-1">
                                <p class="text-[14px] text-gray-500 truncate pr-2 flex items-center leading-tight">
                                    ${statusIcon} ${c.last_msg || 'Nenhuma mensagem'}
                                </p>
                                ${c.unread > 0 ? `<span class="bg-[#FF3B30] text-white text-[12px] font-bold px-1.5 py-0.5 rounded-full min-w-[20px] h-[20px] flex items-center justify-center shrink-0">${c.unread}</span>` : ''}
                            </div>
                        </div>
                    </div>`;
                }).join('');
            } catch(e) {
                console.error("Erro ao carregar chats:", e);
            }
        }

        async function openChat(u) {
            active = u;
            document.getElementById('chat-room').classList.add('chat-open');
            
            try {
                const userData = await fetch('/user/'+u).then(r=>r.json());
                const avatar = userData.avatar || `https://ui-avatars.com/api/?name=${u}`;
                
                document.getElementById('chat_avatar').src = avatar;
                document.getElementById('chat_name').innerHTML = u + ' ' + getVerifiedIcon(userData.is_verified);
                document.getElementById('info_avatar').src = avatar;
                document.getElementById('info_name').innerText = u;
                document.getElementById('info_bio').innerText = userData.bio || 'Sem recado.';
                
                if(userData.is_online) {
                    document.getElementById('chat_status').innerText = 'Online';
                    document.getElementById('chat_status').className = 'text-[12px] text-[#0A84FF] font-medium leading-tight';
                } else {
                    const lastSeen = userData.last_seen ? formatTimeUTC(userData.last_seen) : 'h√° algum tempo';
                    document.getElementById('chat_status').innerText = 'Visto por √∫ltimo ' + lastSeen;
                    document.getElementById('chat_status').className = 'text-[11px] text-gray-400 leading-tight';
                }
                
                loadMessages(u);
                socket.emit('mark_read', {s: u, r: me.username});
                loadChats();
            } catch(e) {
                console.error("Erro ao abrir chat:", e);
            }
        }

        function closeChat() {
            document.getElementById('chat-room').classList.remove('chat-open');
            active = null;
            document.getElementById('chat-input').value = '';
            loadChats();
        }

        async function loadMessages(u) {
            try {
                const msgs = await fetch(`/messages/${me.username}/${u}`).then(r=>r.json());
                const container = document.getElementById('msg-container');
                
                container.innerHTML = msgs.map(m => {
                    const isMe = m.s === me.username;
                    const bubbleClass = isMe ? 'msg-me' : 'msg-them';
                    const time = new Date(m.time).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
                    
                    let content = '';
                    let mediaClass = (m.type === 'image' || m.type === 'video') ? 'msg-media' : '';
                    if(m.type === 'text') {
                        content = `<p class="leading-tight">${escapeHtml(m.c)}</p>`;
                    } else if(m.type === 'image') {
                        content = `<img src="${m.c}">`;
                    } else if(m.type === 'video') {
                        content = `<video src="${m.c}" controls></video>`;
                    }
                    
                    let statusIcon = '';
                    if(isMe) {
                        if(m.status === 2) statusIcon = '<span class="tick-icon tick-read">‚úì‚úì</span>';
                        else if(m.status === 1) statusIcon = '<span class="tick-icon tick-sent">‚úì‚úì</span>';
                        else statusIcon = '<span class="tick-icon tick-sent">‚úì</span>';
                    }
                    
                    return `
                    <div class="msg-bubble ${bubbleClass} ${mediaClass}">
                        ${content}
                        <div class="text-[10px] text-gray-400 mt-1 text-right flex items-center justify-end gap-1">
                            ${time} ${statusIcon}
                        </div>
                    </div>`;
                }).join('');
                
                container.scrollTop = container.scrollHeight;
            } catch(e) {
                console.error("Erro ao carregar mensagens:", e);
            }
        }

        function handleKey(e) {
            if(e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendText();
            }
        }

        function toggleSendBtn() {
            const input = document.getElementById('chat-input');
            const sendBtn = document.getElementById('send-btn');
            const micBtn = document.getElementById('mic-btn');
            
            if(input.value.trim()) {
                sendBtn.classList.remove('hidden');
                micBtn.classList.add('hidden');
            } else {
                sendBtn.classList.add('hidden');
                micBtn.classList.remove('hidden');
            }
        }

        function sendText() {
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            if(!text || !active) return;
            
            socket.emit('send_msg', {s: me.username, r: active, c: text, type: 'text'});
            input.value = '';
            toggleSendBtn();
        }

        function sendMedia(e) {
            const file = e.target.files[0];
            if(!file || !active) return;
            
            const reader = new FileReader();
            reader.onload = (ev) => {
                const type = file.type.startsWith('video') ? 'video' : 'image';
                socket.emit('send_msg', {s: me.username, r: active, c: ev.target.result, type});
            };
            reader.readAsDataURL(file);
            e.target.value = '';
        }

        function toggleMic() {
            alert("üé§ Recurso de √°udio em desenvolvimento");
        }

        function startChat() {
            const u = document.getElementById('new-chat-input').value.trim();
            if(!u) return alert("Digite um usu√°rio");
            if(u === me.username) return alert("Voc√™ n√£o pode conversar consigo mesmo");
            
            document.getElementById('new-chat-modal').classList.add('hidden');
            document.getElementById('new-chat-input').value = '';
            openChat(u);
        }

        // --- FUN√á√ïES DE STATUS ---
        async function loadStatus() {
            try {
                const stories = await fetch('/get-status').then(r=>r.json());
                const listEl = document.getElementById('status-list');
                
                const grouped = {};
                stories.forEach(s => {
                    if(!grouped[s.username]) grouped[s.username] = [];
                    grouped[s.username].push(s);
                });
                
                const myStories = grouped[me.username] || [];
                delete grouped[me.username];
                
                const others = Object.entries(grouped).map(([username, stories]) => {
                    const avatar = stories[0].avatar || `https://ui-avatars.com/api/?name=${username}`;
                    const viewed = stories.every(s => s.viewers.includes(me.username));
                    const ringClass = viewed ? 'status-ring-viewed' : 'status-ring';
                    const time = formatTimeAgo(stories[stories.length - 1].time);
                    
                    return `
                    <div onclick="viewStory('${username}')" class="flex items-center gap-3 py-3 pr-4 border-b border-[#2C2C2E] cursor-pointer active:bg-[#2C2C2E]">
                        <div class="${ringClass}">
                            <img src="${avatar}" class="w-14 h-14 rounded-full bg-gray-700 object-cover">
                        </div>
                        <div class="flex-1">
                            <h3 class="font-bold text-white flex items-center">
                                ${username} ${getVerifiedIcon(stories[0].is_verified)}
                            </h3>
                            <p class="text-gray-400 text-sm">${time}</p>
                        </div>
                    </div>`;
                }).join('');
                
                listEl.innerHTML = others || '<p class="text-gray-500 text-center py-8">Nenhum status dispon√≠vel</p>';
                
            } catch(e) {
                console.error("Erro ao carregar status:", e);
            }
        }

        function checkMyStatus() {
            viewStory(me.username);
        }

        function likeStory(e) {
            if(e) e.stopPropagation();
            const currentStory = currentStories[currentStoryIndex];
            if(!currentStory) return;
            socket.emit('like_story', { storyId: currentStory.id, username: me.username });
        }

        document.getElementById('story-reply-input')?.addEventListener('keypress', (e) => {
            if(e.key === 'Enter' && e.target.value.trim()) {
                const currentStory = currentStories[currentStoryIndex];
                if(!currentStory) return;
                
                const replyText = e.target.value.trim();
                const msg = {
                    s: me.username,
                    r: currentStory.username,
                    c: `Respondeu ao seu status: "${replyText}"`,
                    type: 'text'
                };
                socket.emit('send_msg', msg);
                e.target.value = '';
                alert('Resposta enviada!');
            }
        });

        async function viewStory(username) {
            try {
                const allStories = await fetch('/get-status').then(r=>r.json());
                currentStories = allStories.filter(s => s.username === username);
                
                if(currentStories.length === 0) {
                    return alert("Nenhum status dispon√≠vel");
                }
                
                currentStoryIndex = 0;
                showStoryAtIndex(0);
                document.getElementById('story-viewer').classList.add('active');
                
                if(username === me.username) {
                    document.getElementById('sv-footer').classList.remove('hidden');
                } else {
                    document.getElementById('sv-footer').classList.add('hidden');
                }
            } catch(e) {
                console.error("Erro ao visualizar story:", e);
            }
        }

        function showStoryAtIndex(idx) {
            if(idx < 0 || idx >= currentStories.length) return;
            
            currentStoryIndex = idx;
            const story = currentStories[idx];
            
            const avatar = story.avatar || `https://ui-avatars.com/api/?name=${story.username}`;
            document.getElementById('sv-avatar').src = avatar;
            document.getElementById('sv-username').innerText = story.username;
            document.getElementById('sv-time').innerText = formatTimeAgo(story.time);
            
            const contentEl = document.getElementById('sv-content');
            contentEl.innerHTML = '';
            
            if(story.type === 'text') {
                contentEl.style.background = story.bg_color || '#0099ff';
                contentEl.innerHTML = `<p class="text-white text-3xl font-bold p-8 text-center">${escapeHtml(story.content)}</p>`;
            } else if(story.type === 'image') {
                contentEl.style.background = 'black';
                contentEl.innerHTML = `<img src="${story.content}" class="story-media">`;
            } else if(story.type === 'video') {
                contentEl.style.background = 'black';
                contentEl.innerHTML = `<video src="${story.content}" class="story-media" autoplay></video>`;
            }
            
            const caption = story.caption || '';
            document.getElementById('sv-caption').innerText = caption;
            document.getElementById('sv-caption-container').style.display = caption ? 'block' : 'none';
                        updateProgressBars();
            startStoryTimer();

            // Atualizar bot√£o de like
            const likeBtn = document.getElementById('story-like-btn');
            const likes = JSON.parse(story.likes || '[]');
            if(likes.includes(me.username)) {
                likeBtn.classList.add('liked');
            } else {
                likeBtn.classList.remove('liked');
            }
        }    
            if(story.username !== me.username) {
                socket.emit('view_status', {viewer: me.username, owner: story.username, story_id: story.id});
            }
            
            if(story.username === me.username) {
                updateViewCount();
            }
        }

        function updateProgressBars() {
            const barsContainer = document.getElementById('story-bars');
            barsContainer.innerHTML = currentStories.map((_, i) => `
                <div class="story-progress-bar">
                    <div class="story-progress-fill" id="progress-${i}"></div>
                </div>
            `).join('');
            
            for(let i = 0; i < currentStoryIndex; i++) {
                document.getElementById(`progress-${i}`).style.width = '100%';
            }
        }

        function startStoryTimer() {
            if(storyTimer) clearInterval(storyTimer);
            
            const duration = 5000;
            const interval = 50;
            let elapsed = 0;
            
            storyTimer = setInterval(() => {
                elapsed += interval;
                const progress = (elapsed / duration) * 100;
                const bar = document.getElementById(`progress-${currentStoryIndex}`);
                if(bar) bar.style.width = progress + '%';
                
                if(elapsed >= duration) {
                    clearInterval(storyTimer);
                    nextStory();
                }
            }, interval);
        }

        function nextStory() {
            if(currentStoryIndex < currentStories.length - 1) {
                showStoryAtIndex(currentStoryIndex + 1);
            } else {
                closeStory();
            }
        }

        function prevStory() {
            if(currentStoryIndex > 0) {
                showStoryAtIndex(currentStoryIndex - 1);
            }
        }

        function closeStory() {
            if(storyTimer) clearInterval(storyTimer);
            document.getElementById('story-viewer').classList.remove('active');
            loadStatus();
        }

        async function updateViewCount() {
            try {
                const story = currentStories[currentStoryIndex];
                const viewers = await fetch(`/story-viewers/${story.id}`).then(r=>r.json());
                document.getElementById('sv-view-count').innerText = viewers.length + ' views';
            } catch(e) {
                console.error("Erro ao atualizar views:", e);
            }
        }

        async function showViewers() {
            try {
                const story = currentStories[currentStoryIndex];
                const viewers = await fetch(`/story-viewers/${story.id}`).then(r=>r.json());
                
                const listEl = document.getElementById('viewers-list');
                if(viewers.length === 0) {
                    listEl.innerHTML = '<p class="text-gray-500 text-center">Ningu√©m visualizou ainda</p>';
                } else {
                    listEl.innerHTML = viewers.map(v => `
                        <div class="flex items-center gap-3 p-2">
                            <img src="https://ui-avatars.com/api/?name=${v}" class="w-10 h-10 rounded-full bg-gray-700">
                            <span class="text-white font-medium">${v}</span>
                        </div>
                    `).join('');
                }
                
                document.getElementById('viewers-modal').classList.remove('hidden');
            } catch(e) {
                console.error("Erro ao carregar viewers:", e);
            }
        }

        // --- STATUS CREATOR ---
        function openStatusCreator(mode = 'media') {
            statusCreatorMode = mode;
            document.getElementById('status-creator').classList.add('open');
            
            if(mode === 'text') {
                document.getElementById('st-text-input').classList.remove('hidden');
                document.getElementById('st-controls-text').classList.remove('hidden');
                document.getElementById('st-img-preview').classList.add('hidden');
                document.getElementById('st-video-preview').classList.add('hidden');
                setBg('#0099ff');
            } else {
                document.getElementById('st-file-input').click();
            }
        }

        function closeStatusCreator() {
            document.getElementById('status-creator').classList.remove('open');
            document.getElementById('st-text-input').value = '';
            document.getElementById('st-caption').value = '';
            document.getElementById('st-text-input').classList.add('hidden');
            document.getElementById('st-controls-text').classList.add('hidden');
            document.getElementById('st-img-preview').classList.add('hidden');
            document.getElementById('st-video-preview').classList.add('hidden');
        }

        function setBg(color) {
            statusCreatorBgColor = color;
            document.getElementById('st-preview-area').style.background = color;
        }

        function handleStatusFile(e) {
            const file = e.target.files[0];
            if(!file) {
                closeStatusCreator();
                return;
            }
            
            const reader = new FileReader();
            reader.onload = (ev) => {
                if(file.type.startsWith('video')) {
                    statusCreatorMode = 'video';
                    document.getElementById('st-video-preview').src = ev.target.result;
                    document.getElementById('st-video-preview').classList.remove('hidden');
                    document.getElementById('st-img-preview').classList.add('hidden');
                } else {
                    statusCreatorMode = 'image';
                    document.getElementById('st-img-preview').src = ev.target.result;
                    document.getElementById('st-img-preview').classList.remove('hidden');
                    document.getElementById('st-video-preview').classList.add('hidden');
                }
                document.getElementById('st-text-input').classList.add('hidden');
                document.getElementById('st-controls-text').classList.add('hidden');
            };
            reader.readAsDataURL(file);
            e.target.value = '';
        }

        async function submitStatus() {
            let content = '', type = 'text', caption = '', bg_color = '';
            
            if(statusCreatorMode === 'text') {
                content = document.getElementById('st-text-input').value.trim();
                if(!content) return alert("Digite algo para o status");
                type = 'text';
                bg_color = statusCreatorBgColor;
            } else if(statusCreatorMode === 'image') {
                content = document.getElementById('st-img-preview').src;
                type = 'image';
                caption = document.getElementById('st-caption').value.trim();
            } else if(statusCreatorMode === 'video') {
                content = document.getElementById('st-video-preview').src;
                type = 'video';
                caption = document.getElementById('st-caption').value.trim();
            }
            
            if(!content) return alert("Erro ao processar conte√∫do");
            
            try {
                const res = await fetch('/post-status', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({username: me.username, content, type, caption, bg_color})
                });
                
                if(res.ok) {
                    closeStatusCreator();
                    loadStatus();
                    alert("‚úÖ Status publicado!");
                } else {
                    alert("‚ùå Erro ao publicar status");
                }
            } catch(e) {
                console.error("Erro ao enviar status:", e);
                alert("‚ùå Erro de conex√£o");
            }
        }

        // --- PERFIL ---
        async function updateProfilePic(e) {
            const file = e.target.files[0];
            if(!file) return;
            
            const reader = new FileReader();
            reader.onload = async (ev) => {
                try {
                    const res = await fetch('/update-profile', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({username: me.username, bio: me.bio, avatar: ev.target.result})
                    });
                    
                    const data = await res.json();
                    if(data.ok) {
                        me.avatar = data.avatar;
                        localStorage.setItem('whats_v4', JSON.stringify(me));
                        updateMeUI();
                        alert("‚úÖ Foto atualizada!");
                    } else {
                        alert("‚ùå Erro ao atualizar foto");
                    }
                } catch(e) {
                    console.error("Erro ao atualizar foto:", e);
                    alert("‚ùå Erro de conex√£o");
                }
            };
            reader.readAsDataURL(file);
            e.target.value = '';
        }

        async function saveBio(bio) {
            try {
                const res = await fetch('/update-profile', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({username: me.username, bio, avatar: me.avatar})
                });
                
                if(res.ok) {
                    me.bio = bio;
                    localStorage.setItem('whats_v4', JSON.stringify(me));
                }
            } catch(e) {
                console.error("Erro ao salvar bio:", e);
            }
        }

        // --- SOCKET EVENTS ---
        socket.on('new_msg', m => {
            if(active === m.s) {
                loadMessages(active);
                socket.emit('mark_read', {s: m.s, r: me.username});
            }
            loadChats();
           socket.on('msgs_read_update', d => { 
            if(active === d.reader) {
                loadMessages(active);
            }
            loadChats();
        });

        socket.on('story_liked', d => {
            const story = currentStories.find(s => s.id === d.storyId);
            if(story) story.likes = d.likes;
            
            if(currentStories[currentStoryIndex] && currentStories[currentStoryIndex].id === d.storyId) {
                const likeBtn = document.getElementById('story-like-btn');
                if(d.likes.includes(me.username)) {
                    likeBtn.classList.add('liked');
                } else {
                    likeBtn.classList.remove('liked');
                }
            }
        });        
        socket.on('update_chat_list', () => {
            loadChats();
        });
        
        socket.on('online_list', list => {
            if(active && list.includes(active)) {
                document.getElementById('chat_status').innerText = 'Online';
                document.getElementById('chat_status').className = 'text-[12px] text-[#0A84FF] font-medium leading-tight';
            }
        });

        socket.on('msgs_read_update', d => { 
            if(active === d.reader) {
                document.querySelectorAll('.tick-sent').forEach(e => {
                    e.classList.remove('tick-sent');
                    e.classList.add('tick-read');
                    e.innerHTML = '‚úì‚úì';
                });
            }
        });

        socket.on('user_status_change', data => {
            if(active === data.username) {
                const stDiv = document.getElementById('chat_status');
                if(data.status === 'online') {
                    stDiv.innerText = 'Online';
                    stDiv.className = 'text-[12px] text-[#0A84FF] font-medium leading-tight';
                } else {
                    const time = data.last_seen ? formatTimeUTC(data.last_seen) : 'h√° algum tempo';
                    stDiv.innerText = 'Visto por √∫ltimo ' + time;
                    stDiv.className = 'text-[11px] text-gray-400 leading-tight';
                }
            }
            loadChats();
        });

        socket.on('status_viewed', data => {
            if(document.getElementById('story-viewer').classList.contains('active') && currentStories[currentStoryIndex]?.id === data.story_id) {
                updateViewCount();
            }
        });

        // --- UTILIT√ÅRIOS ---
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatTimeAgo(dateStr) {
            const now = new Date();
            const date = new Date(dateStr);
            const diff = Math.floor((now - date) / 1000);
            
            if(diff < 60) return 'Agora';
            if(diff < 3600) return Math.floor(diff / 60) + ' min atr√°s';
            if(diff < 86400) return Math.floor(diff / 3600) + 'h atr√°s';
            return Math.floor(diff / 86400) + 'd atr√°s';
        }

        function formatTimeUTC(dateStr) {
            const date = new Date(dateStr);
            return 'hoje √†s ' + date.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
        }
    </script>
</body>
</html>
